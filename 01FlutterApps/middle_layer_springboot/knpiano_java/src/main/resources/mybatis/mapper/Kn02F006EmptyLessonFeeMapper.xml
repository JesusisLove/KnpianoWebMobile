<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.liu.springboot04web.mapper.Kn02F006EmptyLessonFeeMapper">

    <!-- æŸ¥è¯¢åœ¨æŒ‡å®šå¹´åº¦è¾¾åˆ°43èŠ‚è¯¾çš„å­¦ç”Ÿåˆ—è¡¨ -->
    <select id="getStudentsReached43Lessons" resultType="com.liu.springboot04web.bean.Kn02F006EmptyLessonFeeBean">
        WITH monthly_summary AS (
            -- è®¡ç®—æ¯ä¸ªå­¦ç”Ÿæ¯æœˆçš„è¯¾ç¨‹æ•°ï¼ˆæ’é™¤ä¸´æ—¶è¯¾ç¨‹ï¼‰
            SELECT
                vLsn.stu_id,
                vLsn.stu_name,
                vLsn.subject_id,
                vLsn.subject_name,
                vLsn.lsn_month,
                SUM(vLsn.lsn_count) AS monthly_count
            FROM v_info_lesson_fee_connect_lsn_and_extraToScheDataCorrect vLsn
            WHERE vLsn.lesson_type = 1  -- æŒ‰æœˆäº¤è´¹çš„å­¦ç”Ÿ
              AND vLsn.lsn_month BETWEEN CONCAT(#{year}, '-01') AND CONCAT(#{year}, '-12')  -- æŒ‡å®šå¹´åº¦
              AND vLsn.lesson_id NOT LIKE 'kn-lsn-tmp-%'  -- æ’é™¤ä¸´æ—¶è¯¾ç¨‹(ç»Ÿè®¡å¹´åº¦43èŠ‚è¯¾ä¸èƒ½æŠŠè™šè¯¾ç®—è¿›å»ï¼Œè¿™æ˜¯AIå¸®æˆ‘è€ƒè™‘çš„ï¼ŒçœŸæ£’ğŸ‘)
            GROUP BY vLsn.stu_id, vLsn.stu_name, vLsn.subject_id, vLsn.subject_name, vLsn.lsn_month
        ),
        cumulative_summary AS (
            -- è®¡ç®—ç´¯è®¡è¯¾ç¨‹æ•°ï¼Œæ‰¾å‡ºè¾¾åˆ°43èŠ‚è¯¾çš„æœˆä»½
            SELECT
                stu_id,
                stu_name,
                subject_id,
                subject_name,
                lsn_month,
                monthly_count,
                SUM(monthly_count) OVER (
                    PARTITION BY stu_id, subject_id
                    ORDER BY lsn_month
                ) AS cumulative_count
            FROM monthly_summary
        )
        SELECT
            cs.stu_id AS stuId,
            cs.stu_name AS stuName,
            cs.subject_id AS subjectId,
            cs.subject_name AS subjectName,
            MAX(cs.cumulative_count) AS cumulativeCount,
            CAST(SUBSTRING(MIN(CASE WHEN cs.cumulative_count >= 43 THEN cs.lsn_month END), 6, 2) AS UNSIGNED) AS monthsCompleted,
            CASE WHEN EXISTS (
                SELECT 1
                FROM t_info_lesson_tmp tmp
                WHERE tmp.stu_id = cs.stu_id
                  AND tmp.subject_id = cs.subject_id
                  AND YEAR(tmp.schedual_date) = #{year}
            ) THEN 1 ELSE 0 END AS hasGenerated
        FROM cumulative_summary cs
        WHERE cs.cumulative_count >= 43  -- åªé€‰æ‹©è¾¾åˆ°43èŠ‚è¯¾çš„è®°å½•
        GROUP BY cs.stu_id, cs.stu_name, cs.subject_id, cs.subject_name
        ORDER BY cs.stu_name, cs.subject_id
    </select>

    <!-- è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ç”Ÿæˆä¸´æ—¶è¯¾ç¨‹å’Œè¯¾è´¹ 
        è°ƒç”¨å­˜å‚¨è¿‡ç¨‹æ—¶ï¼Œåº”è¯¥ä½¿ç”¨<update>æ ‡ç­¾ï¼Œè€Œä¸æ˜¯<select>æ ‡ç­¾
        <select>æ ‡ç­¾è¦æ±‚å¿…é¡»è¿”å›ç»“æœï¼ˆéœ€è¦resultTypeæˆ–resultMapï¼‰
        <update>æ ‡ç­¾ç”¨äºINSERT/UPDATE/DELETEæˆ–è°ƒç”¨æ— è¿”å›å€¼çš„å­˜å‚¨è¿‡ç¨‹
    -->
    <update id="callInsertTmpLessonInfo" statementType="CALLABLE">
        {call sp_insert_tmp_lesson_info(
            #{stuId, mode=IN, jdbcType=VARCHAR},
            #{subjectId, mode=IN, jdbcType=VARCHAR},
            #{targetDate, mode=IN, jdbcType=VARCHAR}
        )}
    </update>

    <!-- æŸ¥è¯¢æŸä¸ªå­¦ç”ŸæŸä¸ªç§‘ç›®åœ¨æŒ‡å®šå¹´åº¦çš„ç©ºæœˆè¯¾è´¹æœˆåº¦æ˜ç»† -->
    <select id="getMonthlyDetailsForCancel" resultType="com.liu.springboot04web.bean.Kn02F006EmptyLessonFeeBean">
        SELECT
            tmp.lsn_tmp_id AS lsnTmpId,
            tmp.stu_id AS stuId,
            tmp.subject_id AS subjectId,
            tmp.schedual_date AS schedualDate,
            fee.lsn_fee_id AS lsnFeeId,
            fee.lsn_fee AS lsnFee,
            fee.own_flg AS ownFlg
        FROM t_info_lesson_tmp tmp
        INNER JOIN t_info_lesson_fee fee ON tmp.lsn_tmp_id = fee.lesson_id
        WHERE tmp.stu_id = #{stuId}
          AND tmp.subject_id = #{subjectId}
          AND YEAR(tmp.schedual_date) = #{year}
        ORDER BY tmp.schedual_date
    </select>

    <!-- è°ƒç”¨å­˜å‚¨è¿‡ç¨‹æ’¤é”€ç©ºæœˆè¯¾è´¹ -->
    <update id="callCancelTmpLessonInfo" statementType="CALLABLE">
        {call sp_cancel_tmp_lesson_info(
            #{lsnTmpId, mode=IN, jdbcType=VARCHAR},
            #{lsnFeeId, mode=IN, jdbcType=VARCHAR}
        )}
    </update>

</mapper>
