<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Jekyll v4.0.1">
    <title>Dashboard Template Â· Bootstrap</title>
    <link rel="canonical" href="https://getbootstrap.com/docs/4.5/examples/dashboard/">
    <link href="../assets/dist/css/bootstrap.css" th:href="@{/webjars/bootstrap/4.5.0/css/bootstrap.css}"
        rel="stylesheet">
    <style>
        .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        @media (min-width: 768px) {
            .bd-placeholder-img-lg {
                font-size: 3.5rem;
            }
        }

        .btn-green {
            background-color: #28a745;
            color: white;
        }

        .nav-tabs .nav-link.active {
            background-color: #28a745;
            color: white;
        }

        .no-info-message {
            font-size: 18px;
        }

        .form-group+.form-group {
            margin-left: 20px;
        }

        .hidden {
            display: none;
        }

        .bank-select {
            width: 200px;
        }

        .payment-controls {
            display: flex;
            align-items: center;
        }

        .payment-controls .form-group {
            margin-bottom: 0;
        }

        #prepayButton {
            height: 38px;
        }

        .business-description {
            margin-top: 20px;
        }

        .business-description dl {
            margin-bottom: 0;
        }

        .business-description dt {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .business-description dd {
            margin-left: 20px;
            margin-bottom: 8px;
        }

        .past-date {
            color: red;
        }

        /* æŠ˜å é¢æ¿ç›¸å…³æ ·å¼ */
        .card-header {
            background-color: #f8f9fa;
            padding: 0.75rem 1.25rem;
        }

        .btn-link {
            color: #333;
            text-decoration: none;
            width: 100%;
            text-align: left;
            padding: 0;
        }

        .btn-link:hover {
            color: #007bff;
            text-decoration: none;
        }

        .card {
            border: 1px solid rgba(0, 0, 0, .125);
            border-radius: .25rem;
            margin-bottom: 1rem;
        }

        .card-body {
            padding: 1.25rem;
        }

        .ml-4 {
            margin-left: 1.5rem !important;
        }
    </style>
    <link href="dashboard.css" th:href="@{/dashboard/dashboard.css}" rel="stylesheet">
</head>

<body>
    <div th:replace="~{commons/bar::topbar}"></div>
    <div class="container-fluid">
        <div class="row">
            <div th:replace="~{commons/bar::sidebar(activeUri='kn_advc_pay_lsn_link_active')}"></div>
            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4">
                <h2 class="mt-4 mb-2">å­¦è´¹é¢„æ”¯ä»˜ç®¡ç†</h2>
                <hr />
                <div id="successMessageDiv" class="alert alert-success mt-3" style="display: none;" role="alert">
                    <p id="successMessageContent"></p>
                </div>

                <b>ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©é¢„æ”¯ä»˜æœˆä»½ï¼Œç‚¹å‡» æ¨ç®—æ’è¯¾æ—¥æœŸ</b>
                <hr />

                <!-- æ¤œç´¢éƒ¨ -->
                <form action="#" th:action="@{/kn_advc_pay_lsn/search}" th:object="${searchForm}" method="get">
                    <div class="form-row">
                        <div class="form-group">
                            <label>å­¦ç”Ÿå§“å</label>
                            <select class="form-control" id="studentSelect" name="stuId">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option th:each="student : ${lsnfeestuList}" th:value="${student.stuId}"
                                    th:text="${student.stuName}"
                                    th:selected="${student.stuId == (advcPayMap != null ? advcPayMap['stuId'] : '')}">
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å¹´åº¦</label>
                            <select class="form-control" id="lsnfeeyear" name="selectedyear">
                                <option th:each="year : ${knyearlist}" th:value="${year}" th:text="${year}"
                                    th:selected="${year == (advcPayMap!= null ? advcPayMap['selectedyear'] : '')}">
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è¯·é€‰æ‹©é¢„æ”¯ä»˜æœˆä»½</label>
                            <select class="form-control" id="monthSelect" name="selectedmonth">
                                <option th:each="month : ${knmonthlist}" th:value="${month}" th:text="${month}"
                                    th:selected="${month == (advcPayMap!= null ? advcPayMap['selectedmonth'] : currentmonth)}">
                                </option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-left: 20px; display: flex; justify-content: center;">
                            <button type="submit" class="btn btn-primary">æ¨ç®—æ’è¯¾æ—¥æœŸ</button>
                        </div>
                    </div>

                    <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
                    <div th:if="${errorMessage}" class="alert alert-danger">
                        é”™è¯¯ä¿¡æ¯ï¼š[[${errorMessage}]]
                    </div>
                    <div th:if="${errorMessage}" class="alert alert-danger">
                        é”™è¯¯ä¿¡æ¯é•¿åº¦ï¼š[[${#strings.length(errorMessage)}]]
                        é”™è¯¯ä¿¡æ¯å†…å®¹ï¼š[[${errorMessage}]]
                    </div>
                    <div th:if="${errorMessage}" class="alert alert-danger"
                        style="color: black !important; display: block !important;">
                        [[${errorMessage}]]
                    </div>
                    <div id="errorMessageDiv" th:if="${errorMessage}" class="alert alert-danger"
                        th:text="${errorMessage}"></div>

                    <hr />

                    <!-- ä¿®æ”¹åçš„ä¸šåŠ¡è¯´æ˜éƒ¨åˆ† -->
                    <div class="card">
                        <div class="card-header" id="businessDescriptionHeader">
                            <h5 class="mb-0">
                                <button class="btn btn-link" type="button" data-toggle="collapse"
                                    data-target="#businessDescriptionCollapse" aria-expanded="false"
                                    aria-controls="businessDescriptionCollapse">
                                    â˜…ä¸šåŠ¡è¯´æ˜
                                </button>
                            </h5>
                        </div>
                        <div id="businessDescriptionCollapse" class="collapse"
                            aria-labelledby="businessDescriptionHeader">
                            <div class="card-body">
                                <dl>
                                    <dd>â‘ è¯¾è´¹é¢„æ”¯ä»˜ï¼Œç›®å‰ä»…é™äºæœˆè®¡åˆ’è¯¾çš„é¢„æ”¯ä»˜ï¼ŒæœˆåŠ è¯¾å’Œè¯¾æ—¶ç»“ç®—çš„è¯¾ç¨‹ä¸èƒ½é¢„å…ˆæ”¯ä»˜è´¹ç”¨ã€‚</dd>
                                    <dd>â‘¡å…ˆå‚ç…§è¯¥ç”Ÿæœ€åä¸€æ¬¡ç­¾åˆ°æ—¥æœŸä¸ºå‚è€ƒ(ç¦»ç°åœ¨æœ€è¿‘çš„ä¸€æ¬¡ç­¾åˆ°è¯¾ä»…é™äºå½“å‰å¹´åº¦)ï¼Œåœ¨ä¸‹ä¸ªæœˆçš„ç¬¬ä¸€ä¸ªæ˜ŸæœŸçš„æ—¥æœŸä½œä¸ºè¯¥ç§‘ç›®çš„æ¨ç®—çš„æ’è¯¾æ—¥æœŸæ—¥æœŸã€‚</dd>
                                    <dd>â‘¢å¦‚æœè¯¥ç”Ÿè¿æœ€åä¸€æ¬¡ç­¾åˆ°çš„æ—¥æœŸéƒ½æ²¡æœ‰ï¼Œåˆ™ä»¥å½“å‰çš„ç³»ç»Ÿæœˆä»½ä¸ºå‚ç…§ä¸ºè¯¥ç§‘ç›®å®‰æ’è¯¥æœˆçš„ç¬¬ä¸€å‘¨çš„æ—¥æœŸä¸ºæ¨ç®—çš„æ’è¯¾æ—¥æœŸæ—¥æœŸã€‚</dd>
                                    <dd>â‘£ã€æ¨ç®—çš„æ’è¯¾æ—¥æœŸã€‘åˆ—ï¼Œè¿™æ˜¯æ ¹æ®å­¦ç”Ÿæœ€è¿‘ä¸€æ¬¡çš„ä¸Šè¯¾æ—¥æœŸæ¨ç®—æ˜¯å‘¨å‡ ï¼Œæ ¹æ®æ˜ŸæœŸæ¨ç®—å¯¹è±¡æœˆçš„è®¡åˆ’æ’è¯¾æ—¥æœŸã€‚</dd>
                                    <dd class="ml-4">å¯¹è±¡æœˆï¼šå¦‚æœæœ¬æœˆæ²¡æœ‰ç­¾åˆ°è®°å½•ï¼Œä½†æ˜¯æœ‰æ’è¯¾è®°å½•ï¼Œæœ¬æœˆå°±æ˜¯é¢„æ”¯ä»˜å¯¹è±¡æœˆã€‚</dd>
                                    <dd class="ml-4">å¯¹è±¡æœˆï¼šå¦‚æœæœ¬æœˆå·²ç»æœ‰ç­¾åˆ°è®°å½•ï¼Œä¸‹æœˆå°±æ˜¯é¢„æ”¯ä»˜å¯¹è±¡æœˆã€‚</dd>
                                    <dd>â‘¤æ³¨æ„ï¼šå¦‚æœå‘ç°æ’è¯¾æ—¥æœŸå­—ä½“æ˜¾ç¤ºçº¢è‰²ï¼Œå°±è¡¨ç¤ºæ¨ç®—çš„è¯¥æ—¥æœŸä¸ç³»ç»Ÿå½“å‰æ—¥æœŸç›¸æ¯”å·²ç»è¿‡æœŸäº†ï¼Œè¯·é€‰æ‹©ç³»ç»Ÿå½“å‰æœˆä»½çš„ä¸‹ä¸€ä¸ªæœˆä»½è¿›è¡Œè¯¾è´¹é¢„æ”¯ä»˜ã€‚</dd>
                                    <dd>â‘¥æ³¨æ„ï¼šå½“ä½ çœ‹åˆ°ã€æ’è¯¾è®¡åˆ’ã€‘è¿™ä¸€åˆ—æ˜¯ç©ºå€¼çš„æ—¶å€™ï¼Œå°±è¡¨ç¤ºè¿™ä¸ªç§‘ç›®åœ¨å›ºå®šæ’è¯¾é‡Œæ²¡æœ‰åšå›ºå®šæ’è¯¾ç™»è®°ï¼Œæ‰€ä»¥éœ€è¦ä½ æ‰‹åŠ¨æ¥å®‰æ’æ’è¯¾æ—¥æœŸã€‚</dd>
                                    <dd>â‘¦åŒå¹´æœˆçš„é¢„æ”¯ä»˜è¯¾è´¹é‡å¤è¾“å…¥ï¼šé‡å¤æ‰§è¡Œé¢„æ”¯ä»˜æ—¶ï¼Œç¨‹åºä¸ä¼šå†åšé‡å¤çš„é¢„æ”¯ä»˜å¤„ç†ã€‚</dd>
                                </dl>
                            </div>
                        </div>
                    </div>

                    <!-- å¦‚æœæ²¡æœ‰å­¦ç”Ÿçš„æœªæ”¯ä»˜ä¿¡æ¯ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯ -->
                    <div class="form-group" th:if="${infoList == null || #lists.isEmpty(infoList)}">
                        <p class="no-info-message">ç›®å‰æ²¡æœ‰å­¦ç”Ÿçš„æœªæ”¯ä»˜ä¿¡æ¯ï¼</p>
                    </div>
                </form>

                <!-- æ˜ç´°éƒ¨ -->
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>é€‰æ‹©</th>
                                <th>å­¦ç”Ÿç¼–å·</th>
                                <th>å­¦ç”Ÿå§“å</th>
                                <th>ç§‘ç›®ç¼–å·</th>
                                <th>ç§‘ç›®åç§°</th>
                                <th>å­ç§‘ç›®ç¼–å·</th>
                                <th>å­ç§‘ç›®åç§°</th>
                                <th>è¯¾ç¨‹å±æ€§</th>
                                <th>è¯¾ç¨‹å•ä»·</th>
                                <th>ä¸Šè¯¾æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</th>
                                <th>è®¡åˆ’æ’è¯¾å±æ€§</th>
                                <th>æ¨ç®—çš„æ’è¯¾æ—¥æœŸ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="info, stat:${infoList}">
                                <td><input type="checkbox" class="row-checkbox" th:data-index="${stat.index}"></td>
                                <td>[[${info.stuId}]]</td>
                                <td>[[${info.stuName}]]</td>
                                <td>[[${info.subjectId}]]</td>
                                <td>[[${info.subjectName}]]</td>
                                <td>[[${info.subjectSubId}]]</td>
                                <td>[[${info.subjectSubName}]]</td>
                                <td>[[${info.lessonType== 1 ? 'æœˆè®¡åˆ’è¯¾':''}]]</td>
                                <td>[[${info.subjectPrice}]]</td>
                                <td>[[${info.minutesPerLsn}]]</td>
                                <td>[[${info.schedualDate != null ? '1' : '0'}]]</td>
                                <td>
                                    <span th:if="${info.schedualDate != null}"
                                        th:text="${#dates.format(info.schedualDate, 'yyyy-MM-dd HH:mm')}"
                                        th:class="${info.schedualDate < #dates.createNow() ? 'past-date' : ''}"></span>
                                    <input th:if="${info.schedualDate == null}" type="text"
                                        class="form-control schedule-input hidden" placeholder="yyyy-MM-dd HH:mm">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <hr />
                <b>ç¬¬äºŒæ­¥ï¼šé€‰ä¸­ğŸ‘†é¢„æ”¯ä»˜çš„ç§‘ç›®ï¼Œé€‰æ‹©ğŸ‘‡è¦æ”¯ä»˜çš„é“¶è¡Œåç§°ï¼Œæ‰§è¡Œè¯¾è´¹é¢„æ”¯ä»˜</b>
                <hr />
                <!-- è¯¾è´¹é¢„æ”¯ä»˜æŒ‰é’®å’Œé“¶è¡Œé€‰æ‹© -->
                <div class="mt-3 payment-controls">
                    <div class="form-group d-flex align-items-center mr-3 mb-0">
                        <label for="bankSelect" class="mr-2 mb-0">é“¶è¡Œåç§°</label>
                        <select class="form-control bank-select" id="bankSelect" name="bankId">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option th:each="element,iterStat : ${bankMap}" th:value="${element.key}"
                                th:utext="${element.value}"
                                th:selected="${element.key == (selectedinfo != null ? selectedinfo.bankId : iterStat.index == 0)}">
                            </option>
                        </select>
                    </div>
                    <button type="button" id="prepayButton" class="btn btn-green">è¯¾è´¹é¢„æ”¯ä»˜</button>
                </div>
                <hr />

                <!-- å¦‚æœæ²¡æœ‰å­¦ç”Ÿçš„æœªæ”¯ä»˜ä¿¡æ¯ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯ -->
                <div class="form-group" th:if="${historyList == null || #lists.isEmpty(historyList)}">
                    <p class="no-info-message">ç›®å‰æ²¡æœ‰å­¦ç”Ÿè¯¾è´¹é¢„æ”¯ä»˜çš„å†å²è®°å½•ï¼</p>
                </div>

                <!-- è¯¾è´¹é¢„æ”¯ä»˜å†å²æ˜ç´° -->
                <div class="form-group" th:unless="${historyList == null || #lists.isEmpty(historyList)}">
                    <p class="no-info-message">å­¦ç”Ÿè¯¾è´¹é¢„æ”¯ä»˜çš„å†å²è®°å½•</p>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>è¯¾ç¨‹ç¼–å·</th>
                                <th>è¯¾è´¹ç¼–å·</th>
                                <th>æ”¯ä»˜ç¼–å·</th>
                                <th>å­¦ç”Ÿç¼–å·</th>
                                <th>å­¦ç”Ÿåç§°</th>
                                <th>ç§‘ç›®ç¼–å·</th>
                                <th>ç§‘ç›®åç§°</th>
                                <th>å­ç§‘ç›®ç¼–å·</th>
                                <th>å­ç§‘ç›®åç§°</th>
                                <th>æ’è¯¾æ—¥æœŸ</th>
                                <th>é¢„æ”¯ä»˜é‡‘é¢</th>
                                <th>é“¶è¡Œç¼–å·</th>
                                <th>é“¶è¡Œåç§°</th>
                                <th>é¢„æ”¯ä»˜ä½¿ç”¨çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="info, stat:${historyList}">
                                <td th:text="${stat.index + 1}"></td>
                                <td>[[${info.lessonId}]]</td>
                                <td>[[${info.lsnFeeId}]]</td>
                                <td>[[${info.lsnPayId}]]</td>
                                <td>[[${info.stuId}]]</td>
                                <td>[[${info.stuName}]]</td>
                                <td>[[${info.subjectId}]]</td>
                                <td>[[${info.subjectName}]]</td>
                                <td>[[${info.subjectSubId}]]</td>
                                <td>[[${info.subjectSubName}]]</td>
                                <td>
                                    <span th:if="${info.schedualDate != null}"
                                        th:text="${#dates.format(info.schedualDate, 'yyyy-MM-dd HH:mm')}"
                                        th:class="${info.schedualDate < #dates.createNow() ? 'past-date' : ''}"></span>
                                    <input th:if="${info.schedualDate == null}" type="text"
                                        class="form-control schedule-input hidden" placeholder="yyyy-MM-dd HH:mm">
                                </td>
                                <td>[[${info.lsnPay}]]</td>
                                <td>[[${info.bankId}]]</td>
                                <td>[[${info.bankName}]]</td>
                                <td>[[${info.advcFlg == 0 ? 'ä½¿ç”¨ä¸­' : 'å·²åºŸå¼ƒ'}]]</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <!--Bootstrap core JavaScript-->
    <script type="text/javascript" th:src="@{/webjars/jquery/3.5.1/jquery.slim.min.js}"></script>
    <script type="text/javascript" th:src="@{/webjars/popper.js/1.16.0/umd/popper.min.js}"></script>
    <script type="text/javascript" th:src="@{/webjars/bootstrap/4.5.0/js/bootstrap.min.js}"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // ä½¿ç”¨Thymeleafå†…è”æ–¹å¼è·å–æ¶ˆæ¯
        var successMessage = /*[[${successMessage}]]*/ null;
        var errorMessage = /*[[${errorMessage}]]*/ null;

        document.addEventListener('DOMContentLoaded', function () {
            console.log("DOMContentLoaded event fired");
            console.log("Success Message:", successMessage);
            console.log("Error Message:", errorMessage);

            if (successMessage && successMessage !== 'null') {
                document.getElementById('successMessageContent').textContent = successMessage;
                document.getElementById('successMessageDiv').style.display = 'block';
            }

            if (errorMessage && errorMessage !== 'null') {
                document.getElementById('errorMessageContent').textContent = errorMessage;
                document.getElementById('errorMessageDiv').style.display = 'block';
            }
        });

        // å¤„ç†å¤é€‰æ¡†æ”¹å˜äº‹ä»¶
        document.querySelectorAll('.row-checkbox').forEach(function (checkbox) {
            checkbox.addEventListener('change', function () {
                var row = this.closest('tr');
                var scheduleInput = row.querySelector('.schedule-input');
                if (scheduleInput) {
                    scheduleInput.classList.toggle('hidden', !this.checked);
                }
            });
        });

        // è¯¾è´¹é¢„æ”¯ä»˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('prepayButton').addEventListener('click', function () {
            var selectedRows = [];
            var bankId = document.getElementById('bankSelect').value;

            if (!bankId) {
                alert('è¯·é€‰æ‹©é“¶è¡Œ');
                return;
            }

            document.querySelectorAll('.row-checkbox:checked').forEach(function (checkbox) {
                var row = checkbox.closest('tr');
                var scheduleType = parseInt(row.cells[10].textContent);
                var schedulePlan = scheduleType === 1 ? row.cells[11].querySelector('span').textContent : row.cells[11].querySelector('input').value;

                if (scheduleType === 0 && !isValidDateFormat(schedulePlan)) {
                    alert('è¯·è¾“å…¥"yyyy-MM-dd HH:mm"æ ¼å¼çš„æ—¥æœŸã€‚');
                    return;
                }

                selectedRows.push({
                    subjectId: row.cells[3].textContent,
                    subjectSubId: row.cells[5].textContent,
                    subjectName: row.cells[4].textContent,
                    subjectSubName: row.cells[6].textContent,
                    stuId: row.cells[1].textContent,
                    stuName: row.cells[2].textContent,
                    classDuration: parseInt(row.cells[9].textContent),
                    lessonType: 1,
                    schedualType: scheduleType,
                    schedualDate: schedulePlan,
                    subjectPrice: parseFloat(row.cells[8].textContent),
                    minutesPerLsn: parseInt(row.cells[9].textContent)
                });
            });

            if (selectedRows.length > 0) {
                sendDataToServer(selectedRows, bankId);
            } else {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€è¡Œæ•°æ®ã€‚');
            }
        });

        function isValidDateFormat(dateString) {
            var regex = /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/;
            return regex.test(dateString);
        }

        function sendDataToServer(selectedRows, bankId) {
            var dataToSend = selectedRows.map(row => ({
                ...row,
                bankId: bankId
            }));

            fetch('/liu/kn_advc_pay_lsn_execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataToSend),
            })
                .then(response => {
                    console.log("Response status:", response.status);
                    console.log("Response redirected:", response.redirected);

                    if (response.redirected) {
                        console.log("Redirecting to:", response.url);
                        window.location.replace(response.url);
                    } else if (!response.ok) {
                        throw new Error('Server response was not ok.');
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert('è¯¾è´¹é¢„æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚é”™è¯¯è¯¦æƒ…ï¼š' + error.message);
                });
        }
        /*]]>*/
    </script>
</body>

</html>