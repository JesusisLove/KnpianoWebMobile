<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Fragments</title>
    <style>
        .column-control {
            text-align: right;
            margin-bottom: 10px;
            position: relative;
        }

        .column-menu {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            right: 0;
            top: 100%;
            min-width: 150px;
        }

        .column-menu.show {
            display: block;
        }

        .column-menu label {
            display: block;
            padding: 5px;
            cursor: pointer;
            white-space: nowrap;
        }

        .column-menu label:hover {
            background-color: #f5f5f5;
        }

        /* ç¡®ä¿æ“ä½œåˆ—å§‹ç»ˆæ˜¾ç¤º */
        .action-column {
            display: table-cell !important;
        }
    </style>
</head>

<body>
    <div th:fragment="lessonTable(stuid, stuName)">
        <!-- åˆ—æ§åˆ¶æŒ‰é’®å’Œèœå• -->
        <div class="column-control">
            <button onclick="toggleColumnMenu(event)" class="btn btn-sm btn-secondary">
                æ˜¾ç¤º/éšè—åˆ—
            </button>
            <div id="columnMenu" class="column-menu">
                <label>
                    <input type="checkbox" checked onchange="toggleColumn('col-lessonId')" /> è¯¾ç¨‹ç¼–å·
                </label>
                <label>
                    <input type="checkbox" checked onchange="toggleColumn('col-subjectId')" /> ç§‘ç›®ç¼–å·
                </label>
                <label>
                    <input type="checkbox" checked onchange="toggleColumn('col-subjectSubId')" /> å­ç§‘ç›®ç¼–å·
                </label>
                <label>
                    <input type="checkbox" checked onchange="toggleColumn('col-stuId')" /> å­¦ç”Ÿç¼–å·
                </label>
                <label>
                    <input type="checkbox" checked onchange="toggleColumn('col-subjectName')" /> ç§‘ç›®åç§°
                </label>
                <label>
                    <input type="checkbox" checked onchange="toggleColumn('col-subjectLevel')" /> å­ç§‘ç›®åç§°
                </label>
                <label>
                    <input type="checkbox" checked onchange="toggleColumn('col-classDuration')" /> ä¸Šè¯¾æ—¶é•¿
                </label>
                <label>
                    <input type="checkbox" checked onchange="toggleColumn('col-lessonType')" /> è¯¾ç¨‹ç¨®åˆ¥
                </label>
                <label>
                    <input type="checkbox" checked onchange="toggleColumn('col-schedualType')" /> æ’è¯¾æ‰‹æ®µ
                </label>
                <label>
                    <input type="checkbox" checked onchange="toggleColumn('col-schedualDate')" /> è®¡åˆ’è¯¾æ—¥æœŸ
                </label>
                <label>
                    <input type="checkbox" checked onchange="toggleColumn('col-adjustedDate')" /> è°ƒè¯¾æ—¥æœŸ
                </label>
                <label>
                    <input type="checkbox" checked onchange="toggleColumn('col-extraToDurDate')" /> åŠ è¯¾æ¢æ­£è¯¾æ—¥æœŸ
                </label>
                <label>
                    <input type="checkbox" checked onchange="toggleColumn('col-scanQrDate')" /> ä¸Šè¯¾ç­¾åˆ°æ—¥æœŸ
                </label>
                <label>
                    <input type="checkbox" checked onchange="toggleColumn('col-payFlg')" /> æ”¯ä»˜çŠ¶å†µ
                </label>
                <label>
                    <input type="checkbox" checked onchange="toggleColumn('col-changingEffect')" /> æ¢æ­£è¯¾æœæ•ˆ
                </label>
                <label>
                    <input type="checkbox" checked onchange="toggleColumn('col-memoReason')" /> æ¢æ­£è¯¾æœæ•ˆ
                </label>
            </div>
        </div>
        <div th:id="${stuid}" class="tab-pane fade" th:classappend="'show active'">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th class="col-lessonId">è¯¾ç¨‹<br>ç¼–å·</th>
                        <th class="col-subjectId">ç§‘ç›®<br>ç¼–å·</th>
                        <th class="col-subjectSubId">å­ç§‘ç›®<br>ç¼–å·</th>
                        <th class="col-stuId">å­¦ç”Ÿ<br>ç¼–å·</th>
                        <th class="col-subjectName">ç§‘ç›®<br>åç§°</th>
                        <th class="col-subjectLevel">ç§‘ç›®<br>çº§åˆ«</th>
                        <th class="col-classDuration">ä¸Šè¯¾æ—¶é•¿<br>ï¼ˆåˆ†é’Ÿï¼‰</th>
                        <th class="col-lessonType">è¯¾ç¨‹<br>ç¨®åˆ¥</th>
                        <th class="col-schedualType">æ’è¯¾<br>æ‰‹æ®µ</th>
                        <th class="col-schedualDate">è®¡åˆ’è¯¾<br>æ—¥æœŸ</th>
                        <th class="col-adjustedDate">è°ƒè¯¾<br>æ—¥æœŸ</th>
                        <th class="col-extraToDurDate">åŠ è¯¾æ¢æ­£è¯¾<br>æ—¥æœŸ</th>
                        <th class="col-scanQrDate">ä¸Šè¯¾ç­¾åˆ°<br>æ—¥æœŸ</th>
                        <th class="col-payFlg">æ”¯ä»˜çŠ¶å†µ</th>
                        <th class="col-changingEffect">æ¢æ­£è¯¾æœæ•ˆ</th>
                        <th class="col-memoReason">æ— æ„ä¹‰ç†ç”±</th>
                        <th class="action-column">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="info : ${infoList}" th:if="${info.stuName == stuName}" th:style="${info.extraToDurDate != null ? 'color: black;' : 
                                  info.lessonType == 0 ? 'color: #4CAF50;' : 
                                  info.lessonType == 1 ? 'color: #2196F3;' : 
                                  info.lessonType == 2 ? 'color: #FF69B4;' : ''}">
                        <td class="col-lessonId">[[${info.lessonId}]]</td>
                        <td class="col-subjectId">[[${info.subjectId}]]</td>
                        <td class="col-subjectSubId">[[${info.subjectSubId}]]</td>
                        <td class="col-stuId">[[${info.stuId}]]</td>
                        <td class="col-subjectName">[[${info.subjectName}]]</td>
                        <td class="col-subjectLevel">[[${info.subjectSubName}]]</td>
                        <td class="col-classDuration">[[${info.classDuration}]]</td>
                        <td class="col-lessonType" th:text="${info.lessonType == 0 ? 'è¯¾ç»“ç®—' : 
                                      info.lessonType == 1 ? 'æœˆè®¡åˆ’' : 
                                      info.extraToDurDate != null ? 'å·²æ¢æ­£è¯¾' : 'æœˆåŠ è¯¾'}"></td>
                        <td class="col-schedualType"
                            th:text="${info.schedualType == 0 ? 'æ‰‹åŠ¨æ’è¯¾' : info.schedualType == 1 ? 'Batchæ’è¯¾' : 'ä¸æ˜'}">
                        </td>
                        <td class="col-schedualDate">[[${info.schedualDate != null ?
                            #dates.format(info.schedualDate,'yyyy/MM/dd HH:mm') : ''}]]</td>
                        <td class="col-adjustedDate">[[${info.lsnAdjustedDate != null ?
                            #dates.format(info.lsnAdjustedDate,'yyyy/MM/dd HH:mm') : ''}]]</td>
                        <td class="col-extraToDurDate">[[${info.extraToDurDate != null ?
                            #dates.format(info.extraToDurDate,'yyyy/MM/dd') : ''}]]</td>
                        <td class="col-scanQrDate">[[${info.scanQrDate != null ?
                            #dates.format(info.scanQrDate,'yyyy/MM/dd') : ''}]]</td>
                        <td class="col-payFlg">[[${info.payFlg}]]</td>
                        <td class="col-changingEffect">
                            <span th:if="${info.payFlg == 0 && info.extraToDurDate != null}"
                                th:text="${info.isGoodChange == 1 ? 'æœ‰æ„ä¹‰çš„æ¢è¯¾' : 'æ— æ„ä¹‰çš„æ¢è¯¾'}" th:style="${info.isGoodChange == 1 ? 
                                          'color: #4CAF50; font-weight: bold;' : 
                                          'color: #FF0000; font-weight: bold;'}">
                            </span>
                            <span th:if="${info.payFlg == 1 && info.extraToDurDate != null }"
                                th:text="${info.isGoodChange == 1 ? 'æœ‰æ„ä¹‰çš„æ¢è¯¾' : 'æ— æ„ä¹‰çš„æ¢è¯¾'}" th:style="${info.isGoodChange == 1 ? 
                                          'color: #4CAF50; font-weight: bold;' : 
                                          'color: #FF0000; font-weight: bold;'}">
                            </span>
                        </td>
                        
                        <!-- th:utext ä¼šæŠŠ HTML æ ‡ç­¾æ­£ç¡®è§£æï¼Œ memoReasoné‡Œé¢æœ‰<br>,ä¼šæŠŠ<br>è§£ææˆTHMLçš„æ¢è¡Œç¬¦ï¼Œè¾¾åˆ°æ–‡æœ¬çš„æ¢è¡Œæ˜¾ç¤ºğŸ‘-->
                        <td class="col-memoReason" style="font-size: 8px;" th:utext="${info.memoReason}">[[${info.memoReason}]]</td>

                        <td class="action-column">
                            <div th:if="${info.payFlg == 0}">
                                <a class="btn btn-sm btn-primary" th:if="${info.extraToDurDate == null}"
                                    th:href="@{/kn_extra_lsn_detail/}+${info.lessonId}" methods="GET">åŠ è¯¾æ¢æ­£è¯¾</a>
                                <a class="btn btn-sm btn-danger" th:unless="${info.extraToDurDate == null}"
                                    th:href="@{/kn_extra_lsn_undo/{id}(id=${info.lessonId})}" methods="GET">æ’¤é”€</a>
                            </div>
                            <div th:if="${info.payFlg == 1}">
                                <a class="btn btn-sm btn-secondary disabled" style="cursor: not-allowed; opacity: 0.65;"
                                    role="button">å·²ç»“ç®—å®Œäº†</a>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- åˆ—æ§åˆ¶ç›¸å…³çš„ JavaScript -->
        <script th:inline="javascript">
            // å­˜å‚¨åˆ—æ˜¾ç¤ºçŠ¶æ€
            var columnStates = JSON.parse(localStorage.getItem('columnStates') || '{}');

            // æ§åˆ¶åˆ—æ˜¾ç¤ºèœå•çš„æ˜¾ç¤º/éšè—
            function toggleColumnMenu(event) {
                event.stopPropagation();
                const menu = document.getElementById('columnMenu');
                menu.classList.toggle('show');
            }

            // æ§åˆ¶åˆ—çš„æ˜¾ç¤º/éšè—ï¼ˆåŒæ­¥åˆ°æ‰€æœ‰Tabï¼‰
            function toggleColumn(columnClass) {
                // æ›´æ–°çŠ¶æ€
                columnStates[columnClass] = !columnStates[columnClass];
                const isVisible = columnStates[columnClass];

                // æ›´æ–°æ‰€æœ‰å…·æœ‰è¯¥ç±»åçš„å…ƒç´ 
                const cells = document.getElementsByClassName(columnClass);
                Array.from(cells).forEach(cell => {
                    cell.style.display = isVisible ? '' : 'none';
                });

                // ä¿å­˜çŠ¶æ€
                localStorage.setItem('columnStates', JSON.stringify(columnStates));

                // åŒæ­¥æ‰€æœ‰Tabä¸­çš„å¤é€‰æ¡†çŠ¶æ€
                const checkboxes = document.querySelectorAll(`input[onchange="toggleColumn('${columnClass}')"]`);
                checkboxes.forEach(checkbox => {
                    checkbox.checked = isVisible;
                });
            }

            // åº”ç”¨ä¿å­˜çš„åˆ—çŠ¶æ€
            function applyColumnStates() {
                Object.entries(columnStates).forEach(([columnClass, isVisible]) => {
                    const cells = document.getElementsByClassName(columnClass);
                    Array.from(cells).forEach(cell => {
                        cell.style.display = isVisible ? '' : 'none';
                    });

                    // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
                    const checkboxes = document.querySelectorAll(`input[onchange="toggleColumn('${columnClass}')"]`);
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = isVisible;
                    });
                });
            }

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
            document.addEventListener('click', function (event) {
                const menu = document.getElementById('columnMenu');
                if (!event.target.closest('.column-control')) {
                    menu.classList.remove('show');
                }
            });

            // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–åˆ—çŠ¶æ€
            document.addEventListener('DOMContentLoaded', function () {
                applyColumnStates();
            });

            // ç›‘å¬Tabåˆ‡æ¢äº‹ä»¶
            document.addEventListener('shown.bs.tab', function () {
                applyColumnStates();
            });
        </script>
    </div>
</body>

</html>