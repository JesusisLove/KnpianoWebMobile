<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Jekyll v4.0.1">
    <title>Dashboard Template Â· Bootstrap</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/4.5/examples/dashboard/">

    <link href="../assets/dist/css/bootstrap.css" th:href="@{/webjars/bootstrap/4.5.0/css/bootstrap.css}"
        rel="stylesheet">
    <!-- å¼•å…¥ Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- å¼•å…¥ Bootstrap DateTime Picker CSS -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css">
    <style>
        .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        @media (min-width: 768px) {
            .bd-placeholder-img-lg {
                font-size: 3.5rem;
            }
        }

        /* é¡µé¢æ ‡é¢˜æ ·å¼ */
        .page-title {
            background: #6c5ce7;
            color: white;
            padding: 20px 30px;
            border-radius: 8px;
            margin: 20px 0;
            border: none;
        }

        .page-title h2 {
            margin: 0;
            font-weight: 600;
            font-size: 24px;
        }

        /* è¡¨å•åŒºåŸŸæ ·å¼ */
        .form-section {
            background: #dff0d8;
            border: 2px solid #5cb85c;
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
        }

        .form-title {
            background: #5cb85c;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 25px;
            display: inline-flex;
            align-items: center;
        }

        .form-title::before {
            content: 'ğŸ“';
            margin-right: 10px;
            font-size: 20px;
        }

        /* è¡¨å•è¾“å…¥æ ·å¼ */
        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            font-weight: 600;
            color: #5cb85c;
            margin-bottom: 8px;
            font-size: 14px;
            display: block;
        }

        .form-control {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 12px 15px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            border-color: #5cb85c;
            box-shadow: 0 0 0 0.1rem rgba(92, 184, 92, 0.25);
            background: white;
            outline: none;
        }

        .form-control:disabled,
        .form-control[readonly] {
            background: #f5f5f5;
            border-color: #ccc;
            color: #666;
        }

        /* æŒ‰é’®å®¹å™¨æ ·å¼ */
        .button-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-primary,
        .btn-save {
            background: #5cb85c !important;
            border: none !important;
            color: white !important;
            padding: 12px 24px !important;
            border-radius: 6px !important;
            font-weight: 600 !important;
            font-size: 14px !important;
            transition: all 0.3s ease !important;
        }

        .btn-primary:hover,
        .btn-save:hover {
            background: #4cae4c !important;
            color: white !important;
        }

        /* è¿”å›æŒ‰é’®æ ·å¼ */
        .btn-back {
            background: #6c757d !important;
            border: none !important;
            color: white !important;
            padding: 12px 24px !important;
            border-radius: 6px !important;
            font-weight: 600 !important;
            font-size: 14px !important;
            transition: all 0.3s ease !important;
            text-decoration: none !important;
            display: inline-block !important;
        }

        .btn-back:hover {
            background: #5a6268 !important;
            color: white !important;
            text-decoration: none !important;
        }

        /* ç‰¹æ®Šå­—æ®µæ ·å¼ */
        .readonly-field {
            position: relative;
        }

        .readonly-field::after {
            content: 'ğŸ”’';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #5cb85c;
            font-size: 16px;
            z-index: 10;
        }

        .auto-generated {
            position: relative;
        }

        .auto-generated::after {
            content: 'âš™ï¸';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #5cb85c;
            font-size: 16px;
            z-index: 10;
        }

        /* Radio æŒ‰é’®ç»„æ ·å¼ä¼˜åŒ– */
        .radio-group {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid #ddd;
        }

        .radio-group .form-check {
            display: block;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
        }

        .radio-group .form-check:hover {
            background: rgba(92, 184, 92, 0.1);
            transform: translateX(5px);
            border-color: #5cb85c;
        }

        .radio-group .form-check-input {
            margin-top: 0.3rem;
            margin-right: 10px;
        }

        .radio-group .form-check-input:checked {
            background-color: #5cb85c;
            border-color: #5cb85c;
        }

        .radio-group .form-check-label {
            font-weight: 500;
            color: #333;
            cursor: pointer;
        }

        /* ä¸‹æ‹‰é€‰æ‹©æ¡†æ ·å¼ */
        select.form-control {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%235cb85c' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            size: 1;
        }

        select.form-control option {
            padding: 8px 15px;
            font-size: 14px;
            line-height: 1.5;
            background: white;
            color: #333;
            border: none;
        }

        select.form-control option:hover,
        select.form-control option:focus {
            background-color: #f5f5f5;
            color: #333;
        }

        select.form-control option:checked {
            background-color: #5cb85c;
            color: white;
        }

        select.form-control {
            max-height: none;
            overflow-y: auto;
        }

        #studentSelect,
        #subjectSelect,
        #lsnduration {
            min-height: 45px;
        }

        select[name*="bank"], 
        select[id*="bank"] {
            height: auto;
            min-height: 45px;
        }

        .input-group-append .input-group-text {
            min-width: 60px;
            background: #5cb85c;
            border-color: #5cb85c;
            color: white;
        }
        
        .datetime-container {
            margin-bottom: 20px;
        }
        
        .datetime-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #5cb85c;
        }

        /* æ—¥æœŸè¾“å…¥æ¡†æ ·å¼ */
        input[type="date"],
        input[type="datetime-local"] {
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            padding: 12px 15px;
            font-size: 14px;
        }

        input[type="date"]:focus,
        input[type="datetime-local"]:focus {
            border-color: #5cb85c;
            box-shadow: 0 0 0 0.1rem rgba(92, 184, 92, 0.25);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .page-title h2 {
                font-size: 20px;
            }
            
            .form-section {
                padding: 20px;
            }
            
            .form-title {
                font-size: 16px;
                padding: 10px 16px;
            }

            .radio-group {
                padding: 15px;
            }

            .btn-primary,
            .btn-back {
                padding: 10px 20px !important;
                font-size: 14px !important;
                width: auto;
                min-width: 120px;
            }
            
            .button-container {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-section {
            animation: fadeIn 0.5s ease-out;
        }

        /* è¡¨å•éªŒè¯æ ·å¼ */
        .form-control.is-valid {
            border-color: #5cb85c;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3e%3cpath fill='%235cb85c' d='m2.3 6.73.94-.94 2.94-2.94-1.34-1.34L3.5 3.54l-.61-.61L1.55 4.27z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }

        .form-control.is-invalid {
            border-color: #dc3545;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23dc3545' viewBox='0 0 12 12'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.7.8L6 5.3l-.5-.9z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }

        /* é”™è¯¯æ¶ˆæ¯æ ·å¼ */
        .alert-danger {
            background: #e17055;
            border: none;
            border-radius: 8px;
            color: white;
            margin: 20px 0;
            animation: fadeIn 0.5s ease-out;
        }

        /* éšè—å­—æ®µæ ·å¼ */
        input[type="hidden"] {
            display: none;
        }

        /* å ä½ç¬¦æ–‡æœ¬é¢œè‰² */
        .form-control::placeholder {
            color: #6c757d;
            opacity: 0.8;
        }

        /* é€‰æ‹©æ¡†é€‰ä¸­çŠ¶æ€ */
        .form-control option:checked {
            background-color: #5cb85c;
            color: white;
        }
    </style>
    <link href="dashboard.css" th:href="@{/dashboard/dashboard.css}" rel="stylesheet">
    <!-- [è¯¾ç¨‹æ’ä»–çŠ¶æ€åŠŸèƒ½] 2026-02-08 å†²çªå¯¹è¯æ¡†æ ·å¼ -->
    <link href="conflict-dialog.css" th:href="@{/css/conflict-dialog.css}" rel="stylesheet">
</head>

<body>

    <div th:replace="~{commons/bar::topbar}"></div><!-- thymeleaf å…¬å…±ç‰‡æ®µçš„æŠ½å–å’Œå¼•ç”¨ï¼šåœ¨æ­¤å¼•ç”¨æŠ½å–çš„ç‰‡æ®µ -->
    <div class="container-fluid">
        <div class="row">
            <div th:replace="~{commons/bar::sidebar(activeUri='kn_lsn_001_link_active')}"></div>
            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4">
                <!-- é¡µé¢æ ‡é¢˜ -->
                <div class="page-title">
                    <h2>ğŸ“š æˆæ¥­ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h2>
                </div>

                <!-- è¡¨å•åŒºåŸŸ -->
                <div class="form-section">
                    <div class="form-title">è¯¾ç¨‹ä¿¡æ¯å½•å…¥</div>
                    
                    <!-- æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ -->
                    <div th:if="${errorMessageList}" class="alert alert-danger" role="alert">
                        <div th:each="errorMessage : ${errorMessageList}">
                            <p th:text="${errorMessage}"></p>
                        </div>
                    </div>
                    
                    <!-- [è¯¾ç¨‹æ’ä»–çŠ¶æ€åŠŸèƒ½] 2026-02-08 æ·»åŠ idç”¨äºAJAXæäº¤ -->
                    <form th:action="@{/kn_lsn_001}" method="post" id="lessonForm">
                        <input type="hidden" name="_method" value="put" th:if="${selectedinfo!=null}" />

                        <div class="form-group auto-generated">
                            <label>è¯¾ç¨‹ç¼–å·</label>
                            <input name="lessonId" type="text" class="form-control" placeholder="ã‚·ã‚¹ãƒ†ãƒ è‡ªå‹•æ¡ç•ªã€å…¥åŠ›ä¸å¯" readonly
                                th:value="${selectedinfo!=null}?${selectedinfo.lessonId}">
                        </div>

                        <!-- æ–°è¦ç™»éŒ² æ¨¡å¼ä¸‹ å­¦ç”Ÿå§“åç”¨ ä¸‹æ‹‰åˆ—è¡¨æ¡†æ˜¾ç¤º -->
                        <div class="form-group"
                            th:if="${(selectedinfo==null ) || (#strings.isEmpty(selectedinfo.lessonId))}">
                            <label>å­¦ç”Ÿå§“å</label>
                            <select class="form-control" id="studentSelect" name="stuId">
                                <option value="">è¯·é€‰æ‹©</option>
                                <!-- åŠ¨æ€å†…å®¹å°†è¢«æ’å…¥ -->
                            </select>
                        </div>

                        <!-- å¤‰æ›´ç·¨é›† æ¨¡å¼ä¸‹ å­¦ç”Ÿå§“åç”¨ æ–‡æœ¬æ¡†ä¸”readonlyæ˜¾ç¤º -->
                        <div class="form-group readonly-field" th:if="${selectedinfo!=null && (!#strings.isEmpty(selectedinfo.lessonId))}">
                            <label>å­¦ç”Ÿå§“å</label>
                            <input name="stuName" type="text" class="form-control" th:value="${selectedinfo.stuName}"
                                readonly>
                            <input name="stuId" type="hidden" class="form-control" th:value="${selectedinfo.stuId}">
                        </div>

                        <!-- æ–°è¦ç™»éŒ² æ¨¡å¼ä¸‹ ç§‘ç›®åç§°ç”¨ ä¸‹æ‹‰åˆ—è¡¨æ¡†æ˜¾ç¤º -->
                        <div class="form-group"
                            th:if="${(selectedinfo==null) || (#strings.isEmpty(selectedinfo.lessonId))}">
                            <label>ç§‘ç›®åç§°</label>
                            <select class="form-control" id="subjectSelect" name="subjectId">
                                <option value="">è¯·é€‰æ‹©</option>
                            </select>
                        </div>

                        <!-- æ–°è¦ç™»éŒ² æ¨¡å¼ä¸‹ å­ç§‘ç›®åç§°ç”¨ æ–‡æœ¬æ¡†ä¸”æ“ä½œä¸å¯ -->
                        <div class="form-group readonly-field"
                            th:if="${(selectedinfo==null) || (#strings.isEmpty(selectedinfo.lessonId))}">
                            <label>å­ç§‘ç›®åç§°</label>
                            <input id="subjectSubName" name="subjectSubName" type="text"
                                th:value="${selectedinfo != null ? selectedinfo.subjectSubName : ''}" readonly>
                            <input id="subjectSubId" name="subjectSubId" type="hidden"
                                th:value="${selectedinfo != null ? selectedinfo.subjectSubId : ''}">
                        </div>

                        <!-- å¤‰æ›´ç·¨é›† æ¨¡å¼ä¸‹ ç§‘ç›®åç§°ç”¨ æ–‡æœ¬æ¡†ä¸”readonlyæ˜¾ç¤º -->
                        <div class="form-group readonly-field" th:if="${selectedinfo!=null && (!#strings.isEmpty(selectedinfo.lessonId))}">
                            <label>ç§‘ç›®åç§°</label>
                            <input name="subjectName" type="text" class="form-control"
                                th:value="${selectedinfo.subjectName}" readonly>
                            <input name="subjectId" type="hidden" th:value="${selectedinfo.subjectId}">
                            <input name="delFlg" type="hidden" th:value="${selectedinfo.delFlg}">
                        </div>

                        <!-- å¤‰æ›´ç·¨é›† æ¨¡å¼ä¸‹ å­ç§‘ç›®åç§°ç”¨ æ–‡æœ¬æ¡†ä¸”æ“ä½œä¸ -->
                        <div class="form-group readonly-field" th:if="${selectedinfo!=null && (!#strings.isEmpty(selectedinfo.lessonId))}">
                            <label>å­ç§‘ç›®åç§°</label>
                            <input name="subjectSubName" type="text" th:value="${selectedinfo.subjectSubName}" readonly>
                            <input name="subjectSubId" type="hidden" th:value="${selectedinfo.subjectSubId}">
                        </div>

                        <!-- æ–°è¦ç™»éŒ² æ¨¡å¼ä¸‹çš„è¯¾ç¨‹å±æ€§ ä½¿ç”¨ Radio button -->
                        <div class="form-group"
                            th:if="${(selectedinfo==null) || (#strings.isEmpty(selectedinfo.lessonId))}">
                            <label>è¯¾ç¨‹å±æ€§</label>
                            <div class="radio-group">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="lessonType" id="option0" value="0"
                                        th:checked="${selectedinfo != null and selectedinfo.lessonType == 0}">
                                    <label class="form-check-label" for="option0">è¯¾ç»“ç®—ï¼ˆç§‘ç›®æŒ‰è¯¾æ—¶ç»“ç®—çš„å­¦ç”Ÿï¼‰</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="lessonType" id="option1" value="1"
                                        th:checked="${selectedinfo != null and selectedinfo.lessonType == 1}">
                                    <label class="form-check-label" for="option1">æœˆè®¡åˆ’ï¼ˆç§‘ç›®æŒ‰æœˆäº¤è´¹å­¦ç”Ÿï¼‰</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="lessonType" id="option2" value="2"
                                        th:checked="${selectedinfo != null and selectedinfo.lessonType == 2}">
                                    <label class="form-check-label" for="option2">æœˆåŠ è¯¾ï¼ˆç§‘ç›®å¯¹æŒ‰æœˆäº¤è´¹å­¦ç”Ÿï¼‰</label>
                                </div>
                            </div>
                        </div>

                        <!-- å˜æ›´ç¼–è¾‘ æ¨¡å¼ä¸‹çš„è¯¾ç¨‹å±æ€§ ä½¿ç”¨ æ–‡æœ¬æ¡† -->
                        <div class="form-group readonly-field" th:if="${selectedinfo!=null && (!#strings.isEmpty(selectedinfo.lessonId))}">
                            <label>è¯¾ç¨‹å±æ€§</label>
                            <!-- æ˜¾ç¤ºç”¨çš„æ–‡æœ¬æ¡†ï¼Œç”¨æˆ·æ— æ³•ç¼–è¾‘ -->
                            <input type="text" class="form-control"
                                th:value="${selectedinfo.lessonType == 0 ? 'è¯¾ç»“ç®—' : (selectedinfo.lessonType == 1 ? 'æœˆè®¡åˆ’' : 'æœˆåŠ è¯¾')}"
                                readonly>
                            <!-- éšè—çš„å®é™…æäº¤å€¼çš„è¾“å…¥æ¡† -->
                            <input name="lessonType" type="hidden" th:value="${selectedinfo.lessonType}">
                        </div>

                        <!-- æ–°è§„ç™»é™†ï¼Œå˜æ›´ç¼–è¾‘ ä¸‹æ‹‰åˆ—è¡¨æ¡† é€‰æ‹©å­¦ç”Ÿä¸Šè¯¾æ—¶é•¿ -->
                        <div class="form-group">
                            <label>ä¸Šè¯¾æ—¶é•¿</label>
                            <select class="form-control" name="classDuration" id="lsnduration">
                                <option value="">è¯·é€‰æ‹©ä¸Šè¯¾æ—¶é•¿ </option>
                                <option th:selected="${selectedinfo!=null}?${selectedinfo.classDuration}==${element}"
                                    th:each="element:${duration}" th:value="${element}" th:utext="${element}">
                                </option>
                                </option>
                            </select>
                        </div>
                        
                        <!-- è®¡åˆ’ä¸Šè¯¾æ—¥æœŸ - ä½¿ç”¨textè¾“å…¥é…åˆpattern -->
                        <div class="form-group">
                            <label>è®¡åˆ’ä¸Šè¯¾æ—¥æœŸï¼š</label>
                            <input id="schedualDateInput" name="schedualDate" type="text"
                                class="form-control"
                                th:value="${selectedinfo!=null}?${#dates.format(selectedinfo.schedualDate, 'yyyy-MM-dd HH:mm')}"
                                placeholder="yyyy-MM-dd HH:mm" 
                                pattern="[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}"
                                title="è¯·è¾“å…¥æ ¼å¼ï¼šyyyy-MM-dd HH:mm" />
                        </div>
                        
                        <!-- è¯¾ç¨‹è°ƒæ•´æ—¥æœŸ - ä½¿ç”¨textè¾“å…¥é…åˆpattern -->
                        <div class="form-group">
                            <label>è¯¾ç¨‹è°ƒæ•´æ—¥æœŸï¼š</label>
                            <input id="adjustedDateInput" name="lsnAdjustedDate" type="text"
                                class="form-control"
                                th:value="${selectedinfo!=null}?${#dates.format(selectedinfo.lsnAdjustedDate, 'yyyy-MM-dd HH:mm')}"
                                placeholder="yyyy-MM-dd HH:mm" 
                                pattern="[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}"
                                title="è¯·è¾“å…¥æ ¼å¼ï¼šyyyy-MM-dd HH:mm" />
                        </div>

                        <div class="form-group">
                            <label>è¯¾ç¨‹å±æ€§å˜æ¢æ—¥æœŸï¼ˆå­¦ç”Ÿç”¨é¢å¤–è¿½åŠ çš„è¯¾é¡¶æ›¿æ¥å‘¨æˆ–æ¥æœˆå“ªå¤©çš„è®¡åˆ’è¯¾ç¨‹ï¼‰</label>
                            <input name="extraToDurDate" type="date" class="form-control"
                                th:value="${selectedinfo!=null}?${#dates.format(selectedinfo.extraToDurDate, 'yyyy-MM-dd')}">
                        </div>

                        <div class="form-group">
                            <label>å®é™…ä¸Šè¯¾æ—¥æœŸï¼ˆå­¦ç”Ÿå®é™…æ¥ä¸Šè¯¾çš„æ—¶é—´ï¼‰</label>
                            <input name="scanQrDate" type="date" class="form-control"
                                th:value="${selectedinfo!=null}?${#dates.format(selectedinfo.scanQrDate, 'yyyy-MM-dd')}">
                        </div>
                        
                        <div class="button-container">
                            <a href="javascript:history.back()" class="btn btn-back">ğŸ”™ è¿”å›</a>
                            <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
                        </div>
                    </form>
                </div>
            </main>
        </div>
    </div>

    <!-- å¼•å…¥ Bootstrap JavaScript å’Œ jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>
    <script>
        // ç®€åŒ–çš„JavaScriptï¼Œæ·»åŠ æ—¥æœŸæ ¼å¼éªŒè¯
        $(document).ready(function () {
            // ä¸ºæ—¥æœŸè¾“å…¥æ¡†æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºæ—¥æœŸé€‰æ‹©å™¨
            $('#schedualDateInput, #adjustedDateInput').on('focus', function() {
                // ä¸´æ—¶æ”¹ä¸ºdatetime-localæ¥æ˜¾ç¤ºé€‰æ‹©å™¨
                if (this.type === 'text') {
                    this.type = 'datetime-local';
                    // è½¬æ¢ç°æœ‰å€¼çš„æ ¼å¼
                    if (this.value && this.value.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/)) {
                        this.value = this.value.replace(' ', 'T');
                    }
                }
            });
            
            // å¤±å»ç„¦ç‚¹æ—¶è½¬æ¢å›textæ ¼å¼
            $('#schedualDateInput, #adjustedDateInput').on('blur', function() {
                if (this.type === 'datetime-local') {
                    const value = this.value;
                    this.type = 'text';
                    // è½¬æ¢ä¸ºåç«¯æœŸæœ›çš„æ ¼å¼
                    if (value && value.includes('T')) {
                        this.value = value.replace('T', ' ');
                    }
                }
            });
        });
    </script>

    <script th:inline="javascript">
        // ä»åç«¯ä¼ é€’çš„ stuSubList æ•°æ®
        var jsonStuSubList = /*[[${stuSubList}]]*/[];
        var selectedStuId = /*[[${selectedinfo != null ? selectedinfo.stuId : ''}]]*/'';
        var selectedSubjectId = /*[[${selectedinfo != null ? selectedinfo.subjectId : ''}]]*/'';
        var selectedClassDuration = /*[[${selectedinfo != null ? selectedinfo.classDuration : ''}]]*/'';
        var selectedSchedualDate = /*[[${selectedinfo != null ? #dates.format(selectedinfo.schedualDate, 'yyyy-MM-dd HH:mm') : ''}]]*/'';
        var selectedAdjustedDate = /*[[${selectedinfo != null ? #dates.format(selectedinfo.lsnAdjustedDate, 'yyyy-MM-dd HH:mm') : ''}]]*/'';
        var selectedSubjectSubName = /*[[${selectedinfo != null ? selectedinfo.subjectSubName : ''}]]*/'';
        var selectedSubjectSubId = /*[[${selectedinfo != null ? selectedinfo.subjectSubId : ''}]]*/'';
        var selectedLessonType = /*[[${selectedinfo != null ? selectedinfo.lessonType : ''}]]*/'';

        // é¡µé¢åŠ è½½å®Œæˆåï¼Œåˆå§‹åŒ–å­¦ç”Ÿä¸‹æ‹‰åˆ—è¡¨å’Œå…¶ä»–æ§ä»¶
        window.onload = function () {
            var studentSelect = document.getElementById('studentSelect');
            var subjectSelect = document.getElementById('subjectSelect');
            var uniqueStudentIds = new Set(); // ä½¿ç”¨é›†åˆæ¥é¿å…é‡å¤

            // ä» stuSubList æ·»åŠ å­¦ç”Ÿå§“ååˆ°ä¸‹æ‹‰åˆ—è¡¨ï¼Œç¡®ä¿ä¸é‡å¤
            jsonStuSubList.forEach(function (item) {
                if (!uniqueStudentIds.has(item.stuId)) {
                    uniqueStudentIds.add(item.stuId);
                    var option = new Option(item.stuName, item.stuId);
                    studentSelect.add(option);
                }
            });

            // å¦‚æœé¡µé¢åŠ è½½æ—¶æœ‰é€‰ä¸­çš„å­¦ç”Ÿï¼Œåˆå§‹åŒ–ç§‘ç›®ä¸‹æ‹‰åˆ—è¡¨
            if (selectedStuId) {
                studentSelect.value = selectedStuId;
                updateSubjectSelect(selectedStuId, selectedSubjectId, selectedSubjectSubName, selectedSubjectSubId);
            }

            // ç›‘å¬å­¦ç”Ÿä¸‹æ‹‰åˆ—è¡¨çš„å˜åŒ–ï¼Œå¹¶æ›´æ–°è¯¥ç”Ÿæ­£åœ¨å­¦çš„ç§‘ç›®ä¸‹æ‹‰åˆ—è¡¨
            studentSelect.onchange = function () {
                updateSubjectSelect(this.value, '', '', '');
            };

            // è®¾ç½®ä¸Šè¯¾æ—¶é•¿çš„åˆå§‹å€¼
            if (selectedClassDuration) {
                document.getElementById('lsnduration').value = selectedClassDuration;
            }

            // è®¾ç½®è®¡åˆ’ä¸Šè¯¾æ—¥æœŸçš„åˆå§‹å€¼
            if (selectedSchedualDate) {
                document.getElementById('schedualDateInput').value = selectedSchedualDate;
            }

            // è®¾ç½®è¯¾ç¨‹è°ƒæ•´æ—¥æœŸçš„åˆå§‹å€¼
            if (selectedAdjustedDate) {
                document.getElementById('adjustedDateInput').value = selectedAdjustedDate;
            }

            // è®¾ç½®è¯¾ç¨‹å±æ€§çš„åˆå§‹å€¼
            if (selectedLessonType) {
                document.getElementById('option' + selectedLessonType).checked = true;
                updateLessonType(selectedStuId, selectedSubjectId);
            }
        };

        // æ ¹æ®é€‰ä¸­çš„å­¦ç”Ÿ ID æ›´æ–°ç§‘ç›®ä¸‹æ‹‰åˆ—è¡¨
        function updateSubjectSelect(stuId, selectedSubjectId, selectedSubjectSubName, selectedSubjectSubId) {
            var subjectSelect = document.getElementById('subjectSelect');
            var subjectSubNameInput = document.getElementById('subjectSubName');
            subjectSubNameInput.readonly = true;
            var subjectSubIdInput = document.getElementById('subjectSubId');
            subjectSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>'; // æ¸…ç©ºç°æœ‰çš„ç§‘ç›®é€‰é¡¹

            // æ·»åŠ ä¸é€‰ä¸­å­¦ç”Ÿ ID ç›¸å…³çš„ç§‘ç›®åˆ°ç§‘ç›®ä¸‹æ‹‰åˆ—è¡¨
            jsonStuSubList.forEach(function (item) {
                if (item.stuId === stuId) {
                    var option = new Option(item.subjectName, item.subjectId);
                    subjectSelect.add(option);
                }
            });

            // è®¾ç½®ç§‘ç›®ä¸‹æ‹‰åˆ—è¡¨çš„åˆå§‹å€¼
            if (selectedSubjectId) {
                subjectSelect.value = selectedSubjectId;
                subjectSubNameInput.value = selectedSubjectSubName;
                subjectSubIdInput.value = selectedSubjectSubId;
            }

            // ç›‘å¬ç§‘ç›®ä¸‹æ‹‰åˆ—è¡¨çš„å˜åŒ–ï¼Œå¹¶æ›´æ–°è¯¾ç¨‹å±æ€§çš„ radio buttonå’Œã€Šå­¦ç”Ÿæ¡£æ¡ˆã€‹è¡¨é‡Œè®¾ç½®çš„ä¸Šè¯¾æ—¶é•¿
            subjectSelect.onchange = function () {
                updateLessonType(stuId, this.value);
            };
        }

        // æ ¹æ®é€‰ä¸­çš„å­¦ç”Ÿ ID å’Œç§‘ç›® ID æ›´æ–°è¯¾ç¨‹å±æ€§çš„ radio buttonå’Œã€Šå­¦ç”Ÿæ¡£æ¡ˆã€‹è¡¨é‡Œè®¾ç½®çš„ä¸Šè¯¾æ—¶é•¿
        function updateLessonType(stuId, subjectId) {
            var subjectSubNameInput = document.getElementById('subjectSubName');
            var subjectSubIdInput = document.getElementById('subjectSubId');

            // itemæ˜¯ä»v_latest_subject_info_from_student_documentè§†å›¾é‡ŒæŠ½å‡ºæ¥çš„ç»“æœé›†
            var selectedItem = jsonStuSubList.find(function (item) {
                return item.stuId === stuId && item.subjectId === subjectId;
            });

            // éå†itemï¼Œæ‰¾åˆ°äº†å¯¹è±¡è®°å½•
            if (selectedItem) {
                // è¯¾è´¹æ”¯ä»˜ç§åˆ«
                var payStyle = selectedItem.payStyle;

                // æ ¹æ®è¯¾è´¹æ”¯ä»˜ç§åˆ«æ¥æ›´æ–°è¯¾ç¨‹å±æ€§çš„ radio button
                if (payStyle === 0) {
                    document.getElementById("option0").checked = true;
                    document.getElementById("option0").disabled = false;

                    document.getElementById("option1").disabled = true;
                    document.getElementById("option2").disabled = true;
                } else if (payStyle === 1) {
                    document.getElementById("option0").disabled = true;

                    document.getElementById("option1").checked = true;
                    document.getElementById("option1").disabled = false;

                    document.getElementById("option2").disabled = false;
                }
                // å°†è¯¥å­¦ç”Ÿçš„è¯¥ç§‘ç›®åœ¨ã€Šå­¦ç”Ÿæ¡£æ¡ˆã€‹è¡¨é‡Œè®¾å®šçš„ä¸Šè¯¾æ—¶é•¿å–å‡ºæ¥
                var minutesPerLsn = selectedItem.minutesPerLsn;

                // æ‹¿åˆ°ä¸Šè¯¾æ—¶é•¿ä¸‹æ‹‰åˆ—è¡¨æ¡†æ§ä»¶
                var select = document.getElementById('lsnduration');

                // è®¾ç½®ä¸‹æ‹‰åˆ—è¡¨çš„é€‰å®šå€¼ä¸º minutesPerLsn
                select.value = minutesPerLsn;

                // è®¾ç½®å­ç§‘ç›®åç§°
                subjectSubNameInput.value = selectedItem.subjectSubName;
                subjectSubIdInput.value = selectedItem.subjectSubId;
            }
        }
    </script>

    <!-- [è¯¾ç¨‹æ’ä»–çŠ¶æ€åŠŸèƒ½] 2026-02-08 å†²çªæ£€æµ‹å¯¹è¯æ¡† -->
    <script th:src="@{/js/conflict-warning-dialog.js}"></script>
    <script th:inline="javascript">
        // [è¯¾ç¨‹æ’ä»–çŠ¶æ€åŠŸèƒ½] 2026-02-08/02-10 è¡¨å•æäº¤æ‹¦æˆªï¼Œé›†æˆå†²çªæ£€æµ‹
        $(document).ready(function() {
            // [Bug Fix 2026-02-11] ä½¿ç”¨Thymeleafè·å–æ­£ç¡®çš„ä¸Šä¸‹æ–‡è·¯å¾„URL
            var listPageUrl = /*[[@{/kn_lsn_001}]]*/ '/kn_lsn_001';
            var saveApiUrl = /*[[@{/mb_kn_lsn_001_save}]]*/ '/mb_kn_lsn_001_save';
            var rescheduleApiUrl = /*[[@{/mb_kn_lsn_updatetime}]]*/ '/mb_kn_lsn_updatetime';

            // åˆ¤æ–­æ˜¯æ–°è§„ç™»å½•æ¨¡å¼è¿˜æ˜¯ç¼–è¾‘æ¨¡å¼
            var isNewMode = /*[[${selectedinfo == null || #strings.isEmpty(selectedinfo.lessonId)}]]*/ true;
            var lessonId = /*[[${selectedinfo != null ? selectedinfo.lessonId : ''}]]*/ '';
            var originalAdjustedDate = /*[[${selectedinfo != null ? #dates.format(selectedinfo.lsnAdjustedDate, 'yyyy-MM-dd HH:mm') : ''}]]*/ '';
            var originalDuration = /*[[${selectedinfo != null ? selectedinfo.classDuration : 45}]]*/ 45;

            // [è¯¾ç¨‹æ’ä»–çŠ¶æ€åŠŸèƒ½] 2026-02-12 è®¡ç®—ç»“æŸæ—¶é—´ï¼ˆå¼€å§‹æ—¶é—´ + è¯¾ç¨‹æ—¶é•¿ï¼‰
            function calculateEndTime(startTime, durationMinutes) {
                // startTimeæ ¼å¼: "HH:mm"
                var parts = startTime.split(':');
                if (parts.length !== 2) return startTime;

                var startHour = parseInt(parts[0]) || 0;
                var startMinute = parseInt(parts[1]) || 0;

                var totalMinutes = startHour * 60 + startMinute + durationMinutes;
                var endHour = Math.floor(totalMinutes / 60) % 24;
                var endMinute = totalMinutes % 60;

                return endHour.toString().padStart(2, '0') + ':' + endMinute.toString().padStart(2, '0');
            }

            // [è¯¾ç¨‹æ’ä»–çŠ¶æ€åŠŸèƒ½] 2026-02-12 ä»æ—¥æœŸæ—¶é—´å­—ç¬¦ä¸²æå–æ—¶é—´éƒ¨åˆ†
            function extractTime(dateTimeStr) {
                // dateTimeStræ ¼å¼: "yyyy-MM-dd HH:mm"
                if (!dateTimeStr) return '00:00';
                var parts = dateTimeStr.split(' ');
                return parts.length > 1 ? parts[1] : '00:00';
            }

            if (isNewMode) {
                // ========== æ–°è§„ç™»å½•æ¨¡å¼ï¼šæ‰‹åŠ¨æ’è¯¾å†²çªæ£€æµ‹ ==========
                $('#lessonForm').on('submit', function(e) {
                    e.preventDefault();

                    // æ”¶é›†è¡¨å•æ•°æ®
                    var formData = {
                        stuId: $('#studentSelect').val(),
                        subjectId: $('#subjectSelect').val(),
                        subjectSubId: $('#subjectSubId').val(),
                        lessonType: $('input[name="lessonType"]:checked').val(),
                        classDuration: $('#lsnduration').val(),
                        schedualDate: $('#schedualDateInput').val()
                    };

                    // åŸºæœ¬éªŒè¯
                    if (!formData.stuId) {
                        alert('è¯·é€‰æ‹©å­¦ç”Ÿå§“å');
                        return;
                    }
                    if (!formData.subjectId) {
                        alert('è¯·é€‰æ‹©ç§‘ç›®åç§°');
                        return;
                    }
                    if (!formData.classDuration) {
                        alert('è¯·é€‰æ‹©ä¸Šè¯¾æ—¶é•¿');
                        return;
                    }
                    if (!formData.schedualDate) {
                        alert('è¯·è¾“å…¥è®¡åˆ’ä¸Šè¯¾æ—¥æœŸ');
                        return;
                    }

                    // [è¯¾ç¨‹æ’ä»–çŠ¶æ€åŠŸèƒ½] 2026-02-12 æ„å»ºæ–°æ’è¯¾æ—¶é—´ä¿¡æ¯ï¼Œç”¨äºæ—¶é—´è½´å¯è§†åŒ–
                    var startTime = extractTime(formData.schedualDate);
                    var duration = parseInt(formData.classDuration) || 45;
                    var stuName = $('#studentSelect option:selected').text();
                    var newScheduleInfo = {
                        startTime: startTime,
                        endTime: calculateEndTime(startTime, duration),
                        stuName: stuName
                    };

                    // è°ƒç”¨å†²çªæ£€æµ‹æœåŠ¡
                    LessonConflictService.saveLessonWithConflictCheck(
                        saveApiUrl,
                        formData,
                        newScheduleInfo,
                        function(result) {
                            // æˆåŠŸå›è°ƒ - è·³è½¬åˆ°åˆ—è¡¨é¡µ
                            alert('ä¿å­˜æˆåŠŸ');
                            window.location.href = listPageUrl;
                        },
                        function(errorMsg) {
                            // é”™è¯¯å›è°ƒ
                            alert('ä¿å­˜å¤±è´¥ï¼š' + errorMsg);
                        }
                    );
                });
            } else {
                // ========== [è¯¾ç¨‹æ’ä»–çŠ¶æ€åŠŸèƒ½] 2026-02-10 ç¼–è¾‘æ¨¡å¼ï¼šè°ƒè¯¾å†²çªæ£€æµ‹ï¼ˆå¡è¯¾åœºæ™¯ï¼‰ ==========
                $('#lessonForm').on('submit', function(e) {
                    var newAdjustedDate = $('#adjustedDateInput').val();

                    // æ£€æŸ¥è°ƒè¯¾æ—¥æœŸæ˜¯å¦å‘ç”Ÿå˜åŒ–
                    if (newAdjustedDate && newAdjustedDate !== originalAdjustedDate) {
                        e.preventDefault();

                        // [è¯¾ç¨‹æ’ä»–çŠ¶æ€åŠŸèƒ½] 2026-02-12 æ„å»ºè°ƒè¯¾æ—¶é—´ä¿¡æ¯ï¼Œç”¨äºæ—¶é—´è½´å¯è§†åŒ–
                        var startTime = extractTime(newAdjustedDate);
                        var duration = parseInt($('#lsnduration').val()) || originalDuration || 45;
                        var newScheduleInfo = {
                            startTime: startTime,
                            endTime: calculateEndTime(startTime, duration),
                            stuName: null  // è°ƒè¯¾æ—¶å­¦ç”Ÿä¿¡æ¯å·²åœ¨å†²çªä¸­æ˜¾ç¤º
                        };

                        // è°ƒè¯¾æ—¥æœŸæœ‰å˜æ›´ï¼Œä½¿ç”¨å†²çªæ£€æµ‹API
                        LessonConflictService.rescheduleLessonWithConflictCheck(
                            lessonId,
                            newAdjustedDate,
                            newScheduleInfo,
                            function(result) {
                                // è°ƒè¯¾æˆåŠŸ - è·³è½¬åˆ°åˆ—è¡¨é¡µ
                                alert('è°ƒè¯¾æˆåŠŸ');
                                window.location.href = listPageUrl;
                            },
                            function(errorMsg) {
                                // é”™è¯¯å›è°ƒ
                                alert('è°ƒè¯¾å¤±è´¥ï¼š' + errorMsg);
                            },
                            rescheduleApiUrl
                        );
                    }
                    // å¦‚æœè°ƒè¯¾æ—¥æœŸæœªå˜æ›´ï¼Œä½¿ç”¨åŸæœ‰çš„è¡¨å•æäº¤é€»è¾‘
                });
            }
        });
    </script>
</body>

</html>