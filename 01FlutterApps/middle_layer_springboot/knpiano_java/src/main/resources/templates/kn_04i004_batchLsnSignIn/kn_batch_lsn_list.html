<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Jekyll v4.0.1">
    <title>ä¸€å‘¨è¯¾ç¨‹ç­¾åˆ°è¡¨ Â· KNPiano</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/4.5/examples/dashboard/">

    <!-- Bootstrap core CSS -->
    <link href="../assets/dist/css/bootstrap.css" th:href="@{/webjars/bootstrap/4.5.0/css/bootstrap.css}"
        rel="stylesheet">
    <style>
        .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        @media (min-width: 768px) {
            .bd-placeholder-img-lg {
                font-size: 3.5rem;
            }
        }

        /* Tabæ ·å¼ */
        .nav-tabs .nav-link.active {
            color: #fff !important;
            background-color: #ff009d !important;
            border-color: #ff009d #ff009d #fff !important;
        }
        
        .nav-tabs .nav-link:hover {
            border-color: #ff009d #ff009d #fff;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table th {
            background-color: #f8f9fa;
            border-top: 2px solid #dee2e6;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            font-size: 14px;
            padding: 12px 8px;
        }

        .table td {
            text-align: center;
            vertical-align: middle;
            font-size: 13px;
            padding: 10px 8px;
        }

        .table .student-name {
            color: #ff009d;
            font-weight: 500;
        }

        .table .lesson-id {
            color: #007bff;
            font-weight: 500;
        }

        .table .subject-name {
            color: #28a745;
            font-weight: 500;
        }

        /* é¡µé¢æ ‡é¢˜æ ·å¼ */
        .page-header {
            border-bottom: 2px solid #ff009d;
            padding-bottom: 10px;
            margin-bottom: 25px;
        }

        .page-header h2 {
            color: #333;
            font-weight: 600;
        }

        /* Tabå†…å®¹åŒºåŸŸæ ·å¼ */
        .tab-content {
            margin-top: 20px;
            padding: 20px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }

        /* ç©ºæ•°æ®æç¤ºæ ·å¼ */
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 16px;
        }

        .no-data i {
            font-size: 48px;
            color: #dee2e6;
            margin-bottom: 15px;
            display: block;
        }

        /* æŒ‰é’®åŒºåŸŸæ ·å¼ */
        .action-buttons {
            margin: 30px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            text-align: center;
        }

        .action-buttons .btn {
            margin: 0 10px;
            min-width: 120px;
        }

        .btn-batch-signin {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
            font-weight: 600;
        }

        .btn-batch-signin:hover {
            background-color: #218838;
            border-color: #1e7e34;
            color: white;
        }

        .btn-back {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }

        .btn-back:hover {
            background-color: #5a6268;
            border-color: #545b62;
            color: white;
        }

        /* æ•´å‘¨æ— æ•°æ®æç¤ºæ ·å¼ */
        .no-weekly-lessons {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
        }

        .no-weekly-lessons h5 {
            color: #6c757d;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .no-weekly-lessons p {
            color: #adb5bd;
            font-size: 14px;
            margin: 0;
        }

        .no-weekly-lessons .icon {
            font-size: 48px;
            color: #dee2e6;
            margin-bottom: 20px;
        }
    </style>
    <!-- Custom styles for this template -->
    <link href="dashboard.css" th:href="@{/dashboard/dashboard.css}" rel="stylesheet">
</head>

<body>
    <div th:replace="~{commons/bar::topbar}"></div>
    <div class="container-fluid">
        <div class="row">
            <div th:replace="~{commons/bar::sidebar(activeUri='kn_stu_lsn_sign_link_active')}"></div>
            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4">
                <div class="page-header">
                    <h2 class="mt-4 mb-2">ä¸€å‘¨è¯¾ç¨‹ç­¾åˆ°è¡¨</h2>
                    <p class="text-muted">æŒ‰æ—¥æœŸæŸ¥çœ‹å­¦ç”Ÿè¯¾ç¨‹å®‰æ’ä¿¡æ¯</p>
                </div>

                <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
                <div class="action-buttons">
                    <button type="button" class="btn btn-back" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i> è¿”å›ä¸Šä¸€é¡µ
                    </button>
                    <button type="button" class="btn btn-batch-signin" onclick="executeBatchSignin()">
                        <i class="fas fa-check-circle"></i> æ‰§è¡Œæ‰¹é‡ç­¾åˆ°
                    </button>
                </div>

                <!-- æ£€æŸ¥æ˜¯å¦æœ‰æ•´å‘¨çš„è¯¾ç¨‹æ•°æ® -->
                <div th:if="${lessonsByDate == null or lessonsByDate.isEmpty()}">
                    <!-- æ•´å‘¨æ— è¯¾ç¨‹æ•°æ®çš„æç¤º -->
                    <div class="no-weekly-lessons">
                        <div class="icon">ğŸ“š</div>
                        <h5>ç›®å‰è¿™å‘¨æ²¡æœ‰æœªç­¾åˆ°çš„è¯¾ç¨‹ä¿¡æ¯ï¼</h5>
                        <p>æœ¬å‘¨æ‰€æœ‰è¯¾ç¨‹å¯èƒ½éƒ½å·²ç»ç­¾åˆ°å®Œæˆï¼Œæˆ–è€…è¿˜æ²¡æœ‰å®‰æ’è¯¾ç¨‹ã€‚</p>
                    </div>
                </div>

                <!-- æœ‰è¯¾ç¨‹æ•°æ®æ—¶æ˜¾ç¤ºçš„å†…å®¹ -->
                <div th:if="${lessonsByDate != null and !lessonsByDate.isEmpty()}">
                    <div class="card mt-4">
                        <div class="card-header" id="detailDescriptionHeader">
                            <h5 class="mb-0">
                                <button class="btn btn-link" type="button" data-toggle="collapse" 
                                        data-target="#detailDescriptionCollapse" aria-expanded="true" 
                                        aria-controls="detailDescriptionCollapse">
                                    æ˜ç»†éƒ¨ä¸šåŠ¡è¯´æ˜ï¼š
                                </button>
                            </h5>
                        </div>
                        <div id="detailDescriptionCollapse" class="collapse" 
                                aria-labelledby="detailDescriptionHeader">
                            <div class="card-body">
                                <dl>
                                    <dd class="indented">â‘ è¯¾ç¨‹ä¿¡æ¯æ˜ç»†ï¼šæŠ½å‡ºæ¥çš„æ•°æ®éƒ½æ˜¯æœªç­¾åˆ°çš„æ•°æ®</dd>
                                    <dd class="indented">â‘¡CheckBoxé€‰ä¸­ï¼šæ˜¯ç­¾åˆ°çš„è¯¾ç¨‹å¯¹è±¡</dd>
                                    <dd class="indented">â‘¢CheckBoxä¸ºé€‰ä¸­ä¸”å¤‡æ³¨ä¸ºç©ºï¼šæ˜¯ç­¾åˆ°å¯¹è±¡å¤–ï¼Œå³ä¾¿ç‚¹å‡»æ‰¹é‡ç­¾åˆ°å¤„ç†æŒ‰é’®ï¼Œç¨‹åºä¹Ÿæ˜¯ç©ºå¤„ç†ã€‚</dd>
                                    <dd class="indented">â‘£CheckBoxæœªé€‰ä¸­ä½†å¤‡æ³¨ä¸ç©ºï¼šæ˜¯ç­¾åˆ°å¯¹è±¡å¤–ï¼Œç‚¹å‡»æ‰¹é‡å¤„ç†ä¸ç­¾åˆ°ï¼Œåªæ˜¯æ›´æ–°è¯¥è¯¾ç¨‹çš„å¤‡æ³¨ã€‚</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabå¯¼èˆª - æŒ‰æ—¥æœŸåˆ†ç»„ -->
                    <ul class="nav nav-tabs" id="weeklyTab" role="tablist">
                        <li th:each="entry, iterStat : ${resultsTabStus}" class="nav-item">
                            <a th:classappend="${iterStat.index == 0} ? 'nav-link active' : 'nav-link'"
                                th:id="${'tab-' + entry.key + '-nav'}" 
                                data-toggle="tab" 
                                th:href="'#tab-' + ${entry.key}" 
                                role="tab"
                                th:aria-controls="'tab-' + ${entry.key}"
                                th:aria-selected="${iterStat.index == 0} ? true : false">
                                [[${entry.key}]]ï¼ˆ[[${entry.value}]]ï¼‰
                            </a>
                        </li>
                    </ul>

                    <!-- Tabå†…å®¹åŒºåŸŸ -->
                    <div class="tab-content" id="weeklyTabContent">
                        <div th:each="entry, iterStat : ${resultsTabStus}" 
                             th:id="'tab-' + ${entry.key}" 
                             class="tab-pane fade"
                             th:classappend="${iterStat.index == 0} ? 'show active' : ''" 
                             role="tabpanel"
                             th:aria-labelledby="'tab-' + ${entry.key} + '-nav'">
                            
                            <!-- ç›´æ¥åœ¨è¿™é‡ŒåµŒå…¥Fragmentå†…å®¹ï¼Œä½¿ç”¨th:withç¡®ä¿å‚æ•°æ­£ç¡®ä¼ é€’ -->
                            <div th:with="currentDateKey=${entry.key}, currentWeekDay=${entry.value}">

                                <!-- æ£€æŸ¥æ˜¯å¦æœ‰å½“æ—¥æ•°æ® -->
                                <div th:if="${lessonsByDate != null and lessonsByDate.containsKey(currentDateKey) and !lessonsByDate.get(currentDateKey).isEmpty()}">
                                    <!-- è¯¾ç¨‹ç»Ÿè®¡ä¿¡æ¯ -->
                                    <div style="background-color: #f8f9fa; padding: 10px 20px; border-left: 4px solid #ff009d; margin-bottom: 20px; font-size: 13px; color: #495057;">
                                        å…±æœ‰ [[${lessonsByDate.get(currentDateKey).size()}]] èŠ‚è¯¾ç¨‹
                                    </div>

                                    <!-- è¯¾ç¨‹è¡¨æ ¼ -->
                                    <table class="table table-striped table-sm" style="margin-top: 15px;">
                                        <thead>
                                            <tr>
                                                <th style="width: 4%;">é€‰æ‹©</th>
                                                <th style="width: 8%;">è¯¾ç¨‹ç¼–å·</th>
                                                <th style="width: 8%;">å­¦ç”Ÿç¼–å·</th>
                                                <th style="width: 13%;">å­¦ç”Ÿå§“å</th>
                                                <th style="width: 8%;">ç§‘ç›®ç¼–å·</th>
                                                <th style="width: 10%;">ç§‘ç›®åç§°</th>
                                                <th style="width: 10%;">å­ç§‘ç›®ç¼–å·</th>
                                                <th style="width: 14%;">å­ç§‘ç›®åç§°</th>
                                                <th style="width: 24%;">å¤‡æ³¨</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- ç›´æ¥ä½¿ç”¨é¢„å…ˆåˆ†ç»„çš„æ•°æ® -->
                                            <tr th:each="lesson : ${lessonsByDate.get(currentDateKey)}">
                                                <td>
                                                    <input type="checkbox" 
                                                           class="lesson-checkbox" 
                                                           th:id="'lesson-' + ${currentDateKey} + '-' + ${lesson.lessonId}"
                                                           th:data-tab="${currentDateKey}"
                                                           th:data-lesson-id="${lesson.lessonId}"
                                                           checked="checked">
                                                </td>
                                                <td class="lesson-id">[[${lesson.lessonId}]]</td>
                                                <td>[[${lesson.stuId}]]</td>
                                                <td class="student-name">[[${lesson.stuName}]]</td>
                                                <td>[[${lesson.subjectId}]]</td>
                                                <td class="subject-name">[[${lesson.subjectName}]]</td>
                                                <td>[[${lesson.subjectSubId}]]</td>
                                                <td>[[${lesson.subjectSubName}]]</td>
                                                <td>
                                                    <input type="text" 
                                                           class="form-control form-control-sm lesson-remark" 
                                                           placeholder="å¤‡æ³¨"
                                                           th:id="'remark-' + ${currentDateKey} + '-' + ${lesson.lessonId}"
                                                           th:data-lesson-id="${lesson.lessonId}"
                                                           style="font-size: 12px;"
                                                           th:value="${lesson.memo != null ? lesson.memo : ''}">
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    
                                    <!-- å…¨é€‰æ§åˆ¶ -->
                                    <div style="margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                                        <label class="form-check-label">
                                            <input type="checkbox" 
                                                   class="form-check-input select-all-checkbox" 
                                                   th:id="'selectAll-' + ${currentDateKey}"
                                                   th:data-tab="${currentDateKey}"
                                                   checked="checked">
                                            <strong>å…¨é€‰</strong>
                                        </label>
                                    </div>
                                </div>

                                <!-- å•æ—¥æ— æ•°æ®æç¤º -->
                                <div th:unless="${lessonsByDate != null and lessonsByDate.containsKey(currentDateKey) and !lessonsByDate.get(currentDateKey).isEmpty()}" 
                                     style="text-align: center; padding: 60px 20px; color: #6c757d;">
                                    <div style="font-size: 64px; color: #dee2e6; margin-bottom: 20px;">ğŸ“…</div>
                                    <div style="font-size: 18px; margin-bottom: 10px;">è¯¥æ—¥æœŸæš‚æ— è¯¾ç¨‹å®‰æ’</div>
                                    <div style="font-size: 14px; color: #adb5bd;">[[${currentDateKey}]] ([[${currentWeekDay}]])</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!--Bootstrap core JavaScript-->
    <script type="text/javascript" th:src="@{/webjars/jquery/3.5.1/jquery.slim.min.js}"></script>
    <script type="text/javascript" th:src="@{/webjars/popper.js/1.16.0/umd/popper.min.js}"></script>
    <script type="text/javascript" th:src="@{/webjars/bootstrap/4.5.0/js/bootstrap.min.js}"></script>
    
    <!-- å…¨é€‰åŠŸèƒ½å’Œæ‰¹é‡ç­¾åˆ°JavaScript -->
    <script>
        $(document).ready(function() {
            // å…¨é€‰/å…¨ä¸é€‰åŠŸèƒ½
            $('.select-all-checkbox').change(function() {
                var currentTab = $(this).data('tab');
                var isChecked = $(this).is(':checked');
                
                // è·å–å½“å‰Tabä¸‹çš„æ‰€æœ‰è¯¾ç¨‹checkbox
                $('input.lesson-checkbox[data-tab="' + currentTab + '"]').prop('checked', isChecked);
            });
            
            // å½“å•ä¸ªè¯¾ç¨‹checkboxçŠ¶æ€æ”¹å˜æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°å…¨é€‰çŠ¶æ€
            $(document).on('change', '.lesson-checkbox', function() {
                var currentTab = $(this).data('tab');
                var totalCheckboxes = $('input.lesson-checkbox[data-tab="' + currentTab + '"]').length;
                var checkedCheckboxes = $('input.lesson-checkbox[data-tab="' + currentTab + '"]:checked').length;
                
                var selectAllCheckbox = $('#selectAll-' + currentTab);
                
                if (checkedCheckboxes === totalCheckboxes) {
                    // å¦‚æœæ‰€æœ‰è¯¾ç¨‹éƒ½è¢«é€‰ä¸­ï¼Œåˆ™å…¨é€‰checkboxä¹Ÿé€‰ä¸­
                    selectAllCheckbox.prop('checked', true);
                } else {
                    // å¦‚æœä¸æ˜¯æ‰€æœ‰è¯¾ç¨‹éƒ½è¢«é€‰ä¸­ï¼Œåˆ™å…¨é€‰checkboxä¸é€‰ä¸­
                    selectAllCheckbox.prop('checked', false);
                }
            });
            
            // Tabåˆ‡æ¢æ—¶ï¼Œç¡®ä¿å…¨é€‰çŠ¶æ€æ­£ç¡®
            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                var targetTab = $(e.target).attr('href').replace('#tab-', '');
                
                // æ£€æŸ¥å½“å‰Tabçš„å…¨é€‰çŠ¶æ€
                var totalCheckboxes = $('input.lesson-checkbox[data-tab="' + targetTab + '"]').length;
                var checkedCheckboxes = $('input.lesson-checkbox[data-tab="' + targetTab + '"]:checked').length;
                
                var selectAllCheckbox = $('#selectAll-' + targetTab);
                selectAllCheckbox.prop('checked', checkedCheckboxes === totalCheckboxes);
            });
        });

        // è¿”å›ä¸Šä¸€é¡µåŠŸèƒ½
        function goBack() {
            if (confirm('ç¡®å®šè¦è¿”å›ä¸Šä¸€é¡µå—ï¼Ÿæœªä¿å­˜çš„æ•°æ®å°†ä¸¢å¤±ã€‚')) {
                window.history.back();
            }
        }

        // æ‰¹é‡ç­¾åˆ°åŠŸèƒ½
        function executeBatchSignin() {
            // æ£€æŸ¥æ˜¯å¦æœ‰è¯¾ç¨‹æ•°æ®
            if ($('.lesson-checkbox').length === 0) {
                alert('ç›®å‰æ²¡æœ‰æœªç­¾åˆ°çš„è¯¾ç¨‹ä¿¡æ¯ï¼Œæ— æ³•æ‰§è¡Œæ‰¹é‡ç­¾åˆ°æ“ä½œï¼');
                return;
            }

            // æ”¶é›†æ‰€æœ‰Tabçš„æ•°æ®
            var allTabsData = [];
            
            // éå†æ‰€æœ‰Tab
            $('[id^="tab-"][role="tabpanel"]').each(function() {
                var tabId = $(this).attr('id');
                var dateKey = tabId.replace('tab-', '');
                
                // è·å–å½“å‰Tabä¸‹çš„æ‰€æœ‰è¯¾ç¨‹æ•°æ®
                var tabLessons = [];
                $(this).find('.lesson-checkbox').each(function() {
                    var checkbox = $(this);
                    var lessonId = checkbox.data('lesson-id');
                    var isSelected = checkbox.is(':checked') ? 1 : 0;
                    
                    // è·å–å¯¹åº”çš„å¤‡æ³¨
                    var remarkInput = $(this).closest('tr').find('.lesson-remark');
                    var remark = remarkInput.val() || '';
                    
                    tabLessons.push({
                        selected: isSelected,
                        lessonId: lessonId,
                        remark: remark
                    });
                });
                
                // åªæœ‰å½“Tabæœ‰è¯¾ç¨‹æ•°æ®æ—¶æ‰æ·»åŠ 
                if (tabLessons.length > 0) {
                    allTabsData.push({
                        dateKey: dateKey,
                        lessons: tabLessons
                    });
                }
            });
            
            // éªŒè¯æ˜¯å¦æœ‰æ•°æ®
            if (allTabsData.length === 0) {
                alert('æ²¡æœ‰æ‰¾åˆ°ä»»ä½•è¯¾ç¨‹æ•°æ®ï¼');
                return;
            }
            
            // ç»Ÿè®¡é€‰ä¸­çš„è¯¾ç¨‹æ•°é‡
            var totalSelected = 0;
            allTabsData.forEach(function(tab) {
                tab.lessons.forEach(function(lesson) {
                    if (lesson.selected === 1) {
                        totalSelected++;
                    }
                });
            });
            
            // ç¡®è®¤æ“ä½œ
            if (!confirm('ç¡®å®šè¦æ‰§è¡Œæ‰¹é‡ç­¾åˆ°å—ï¼Ÿ\n' +
                        'å…±æœ‰ ' + allTabsData.length + ' ä¸ªæ—¥æœŸçš„æ•°æ®\n' +
                        'å…¶ä¸­ ' + totalSelected + ' èŠ‚è¯¾ç¨‹è¢«é€‰ä¸­è¿›è¡Œç­¾åˆ°')) {
                return;
            }
            
            // æäº¤æ•°æ®åˆ°åç«¯
            submitBatchSigninData(allTabsData);
        }

        // æäº¤æ‰¹é‡ç­¾åˆ°æ•°æ®åˆ°åç«¯
        function submitBatchSigninData(data) {
            // åˆ›å»ºéšè—è¡¨å•
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/liu/batch_lesson_signin';  // ä½ éœ€è¦åœ¨åç«¯åˆ›å»ºè¿™ä¸ªæ¥å£
            form.style.display = 'none';
            
            // æ·»åŠ æ•°æ®å­—æ®µ - å°†JSONæ•°æ®è½¬ä¸ºå­—ç¬¦ä¸²
            var dataInput = document.createElement('input');
            dataInput.type = 'hidden';
            dataInput.name = 'signinData';
            dataInput.value = JSON.stringify(data);
            form.appendChild(dataInput);
            
            // æ·»åŠ è¡¨å•åˆ°é¡µé¢å¹¶æäº¤
            document.body.appendChild(form);
            
            // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
            var submitBtn = $('.btn-batch-signin');
            var originalText = submitBtn.html();
            submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...');
            
            try {
                form.submit();
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.prop('disabled', false).html(originalText);
            }
        }
    </script>
</body>

</html>