# 2025年学费统计数据问题总结

## 问题现象

**等式不成立**：`应收(按月) ≠ 已支付(按月) + 未支付(按月)`

**影响月份**：2025-01、2025-02、2025-07

---

## 问题分类

### 类型1：已支付数据错误（1月、2月）

#### 错误原因
- **表**: `t_info_lesson_pay`（支付记录表）
- **设计要求**: `lsn_fee_id : lsn_pay_id = 1:1`（一个费用最多一次支付）
- **实际情况**: 出现了 `1:2` 的关系（一个费用有两条支付记录）
- **后果**: 已支付金额被重复计算

#### 具体案例
```
t_info_lesson_pay 表中：
kn-fee-76  →  kn-pay-001 (380元)
           →  kn-pay-002 (380元)  ← 重复记录

统计结果：380 × 2 = 760元（错误，应该是380元）
```

#### 解决方案
```sql
-- 删除重复的支付记录，保留一条
DELETE FROM t_info_lesson_pay
WHERE lsn_pay_id = 'kn-pay-002';
```

**结果**: 1月、2月数据修复后，等式成立 ✓

---

### 类型2：未支付数据错误（7月）

#### 错误原因
- **表**: `t_info_lesson_fee`（费用记录表）
- **设计要求**: 一个计划课（lesson_id）每月只能产生一次课费
- **实际情况**: 一个 `lesson_id` 对应了 2 个 `lsn_fee_id`
- **后果**: 同一个月的课费被重复生成，多收了一个月的费用

#### 具体案例
```
t_info_lesson_fee 表中：
kn-stu-66 (Li Jiayang) 2025-07月份：

lesson_id: kn-lsn-123
  ├── kn-fee-001  420元  2025-07  own_flg=0  ← 正常记录
  └── kn-fee-002  420元  2025-07  own_flg=0  ← 重复记录（同一个lesson，同一个月）

统计结果：420 × 2 = 840元（错误，应该是420元）
差额：840 - 420 = 420元
```

#### 解决方案
```sql
-- 删除重复的费用记录，保留一条
DELETE FROM t_info_lesson_fee
WHERE lsn_fee_id = 'kn-fee-002';
```

**结果**: 7月数据修复后，等式成立 ✓

---

## 核心结论

### ✅ 共同点
1. **问题性质**: 都是**数据重复**问题，不是SQL逻辑错误
2. **验证方法**: 其他月份数据都正确 → 证明SQL逻辑是对的
3. **解决方式**: **只删除重复数据**，不修改任何视图SQL

### ✅ 关键规则

**t_info_lesson_fee 表**：
- 关系规则：对于按月交费的学生，同一个月不能有两个课费记录
- 含义：按月交费的学生不能一个月交两次该月的课费

**t_info_lesson_pay 表**：
- 关系规则：一个 `lsn_fee_id` 最多一个 `lsn_pay_id`
- 含义：一笔费用不能有两条支付记录

### ✅ 调查思路

```
1. 发现等式不成立
   ↓
2. 对比三个分支（应收、已支付、未支付）的数据
   ↓
3. 按学生对比，找出异常学生
   ↓
4. 查看该学生的底层表数据
   ↓
5. 发现数据重复
   ↓
6. 删除重复记录
   ↓
7. 验证等式成立 ✓
```

### ❌ 错误的调查方向（避免）
- ❌ 对比记录数（三个分支的记录数本来就不相关）
- ❌ 修改视图SQL（其他月份都对，说明SQL是对的）
- ❌ 怀疑INNER JOIN问题（这是设计问题，不是当前bug的原因）

### ✅ 正确的调查方向
- ✅ 只关注金额，不关注记录数
- ✅ 从顶层视图往下追踪到底层表
- ✅ 按学生对比，定位具体问题学生
- ✅ 检查底层表的数据完整性（1:1关系、重复记录）
- ✅ 只修复数据，不改SQL

---

## 最终验证结果

### 2025年全年数据验证（修复后）

| 月份 | 应收 | 已支付 | 未支付 | 验证结果 |
|------|------|--------|--------|---------|
| 2025-01 | 13,260.00 | 12,580.00 | 680.00 | ✓ |
| 2025-02 | 13,507.50 | 12,860.00 | 647.50 | ✓ |
| 2025-03 | 14,247.50 | 12,857.50 | 1,390.00 | ✓ |
| 2025-04 | 12,875.00 | 12,810.00 | 65.00 | ✓ |
| 2025-05 | 13,827.50 | 13,400.00 | 427.50 | ✓ |
| 2025-06 | 13,320.00 | 11,570.00 | 1,750.00 | ✓ |
| 2025-07 | 12,707.50 | 2,940.00 | 9,767.50 | ✓ |
| 2025-08 | 12,892.50 | 2,990.00 | 9,902.50 | ✓ |
| 2025-09 | 14,095.00 | 1,620.00 | 12,475.00 | ✓ |
| 2025-10 | 14,145.00 | 0.00 | 14,145.00 | ✓ |
| 2025-11 | 15,277.50 | 0.00 | 15,277.50 | ✓ |
| 2025-12 | 4,820.00 | 0.00 | 4,820.00 | ✓ |

**总月份数**: 12
**正确月份数**: 12
**错误月份数**: 0
**最终结果**: ✓ 全部正确！

---

## 预防措施

### 数据录入规则
1. **录入费用时**: 检查该 lesson_id 是否已存在 lsn_fee_id（一个lesson只能对应一个fee）
2. **录入支付时**: 检查该 lsn_fee_id 是否已存在 lsn_pay_id（一个fee只能对应一个pay）

### 数据完整性约束（建议）
```sql
-- 在 t_info_lesson_fee 表添加唯一约束
-- 确保一个 lesson_id 只能对应一个 lsn_fee_id
ALTER TABLE t_info_lesson_fee
ADD UNIQUE KEY uk_lesson_fee (lesson_id, del_flg);

-- 在 t_info_lesson_pay 表添加唯一约束
-- 确保一个 lsn_fee_id 只能对应一个 lsn_pay_id
ALTER TABLE t_info_lesson_pay
ADD UNIQUE KEY uk_fee_pay (lsn_fee_id, del_flg);
```

### 定期检查SQL
```sql
-- 检查费用表：一个lesson_id是否对应了多个lsn_fee_id（绝对不允许）
SELECT
    lesson_id,
    COUNT(DISTINCT lsn_fee_id) as fee_count,
    GROUP_CONCAT(DISTINCT lsn_fee_id ORDER BY lsn_fee_id) as fee_ids
FROM t_info_lesson_fee
WHERE del_flg = 0
GROUP BY lesson_id
HAVING COUNT(DISTINCT lsn_fee_id) > 1;

-- 检查支付表：一个lsn_fee_id是否对应了多个lsn_pay_id（绝对不允许）
SELECT
    lsn_fee_id,
    COUNT(*) as pay_count,
    GROUP_CONCAT(lsn_pay_id ORDER BY lsn_pay_id) as pay_ids
FROM t_info_lesson_pay
WHERE del_flg = 0
GROUP BY lsn_fee_id
HAVING COUNT(*) > 1;
```

---

## 相关文件

### 调查文件（保留备查）
- `diagnose_july_issue.sql` - 7月份专项诊断
- `investigate_july_three_branches.sql` - 三分支数据调查
- `查询stu66未支付数据.sql` - kn-stu-66 逐层追踪
- `verify_july_fixed.sql` - 修复后验证（可重复使用）

### 报告文件（可删除）
- `BUG_REPORT.md` - 初期Bug报告（已过时）
- `THREE_VINES_INVESTIGATION.md` - 三藤调查报告（已过时）
- `JULY_ROOT_CAUSE_ANALYSIS.md` - 根本原因分析（已过时）
- `EXECUTION_GUIDE.md` - 执行指南（已过时）
- `fix_july_comprehensive_solution.sql` - 修复方案（未使用，建议删除）
- `fix_final_correct_solution.sql` - 修复方案（未使用，建议删除）

### 保留的有用文件
- `2025年数据问题总结.md` - 本文件（总结报告）
- `verify_july_fixed.sql` - 验证SQL（可用于日常检查）

---

**调查完成日期**: 2025-12-16
**调查结论**: 数据重复问题，已全部修复 ✓
